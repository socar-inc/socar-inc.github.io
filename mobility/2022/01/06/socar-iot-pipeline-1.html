<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    차량용 단말을 위한 IoT 파이프라인 구축기 #1 - SOCAR Tech Blog
    
  </title>

  <meta name="description" content="더 빨리, 더 많이, 더 믿을 수 있게">

  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://tech.socarcorp.kr/mobility/2022/01/06/socar-iot-pipeline-1.html"/>
  <meta property="og:title" content="차량용 단말을 위한 IoT 파이프라인 구축기 #1"/>
  <meta property="og:description" content="더 빨리, 더 많이, 더 믿을 수 있게"/>
  <meta property="og:site_name" content="SOCAR Tech Blog"/>
  <meta property="og:image" content="https://tech.socarcorp.kr/img/iot-pipeline-1/mike-benna-X-NAMq6uP3Q-unsplash.jpg"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="차량용 단말을 위한 IoT 파이프라인 구축기 #1"/>
  <meta name="twitter:description" content="더 빨리, 더 많이, 더 믿을 수 있게"/>
  <meta name="twitter:image" content="https://tech.socarcorp.kr/img/iot-pipeline-1/mike-benna-X-NAMq6uP3Q-unsplash.jpg"/>


  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="/assets/main.css">

  <link rel="canonical" href="https://tech.socarcorp.kr/mobility/2022/01/06/socar-iot-pipeline-1.html">
  <link rel="alternate" type="application/rss+xml" title="SOCAR Tech Blog" href="/feed.xml">
  <link rel="icon" type="image/png" href="/assets/icon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icon/favicon-96x96.png">
</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">SOCAR Tech Blog</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">🏠 Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">✏️ Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/categories">📔 Categories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/tags">🏷 Tags</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/authors">✍🏻 Authors</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/img/iot-pipeline-1/mike-benna-X-NAMq6uP3Q-unsplash.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-9 col-md-9 mx-auto">
          <div class="post-heading">
            <h1 class="post-title">차량용 단말을 위한 IoT 파이프라인 구축기 #1</h1>
            
            <h2 class="subheading">더 빨리, 더 많이, 더 믿을 수 있게</h2>
            
            <div class="post-meta">
              
              
                
                <span class="author"><a href="/authors#스팍"><img src="/assets/authors/spock.jpeg">스팍</a></span>
              
                <br>
                <span class="date">2022-01-06</span>
                <br>
                <span class="category"><a href="/categories#">mobility</a></span> 
                <br>
              
                <span class="tag"><a href="/tags#iot">iot</a></span>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="toc toc-hidden" id="toc">
    </div>
    <div class="row">
      <div class="col-lg-9 col-md-9 mx-auto">
        <div class="post-content">
        <div class="photo-copyright">
Photo by <a href="https://unsplash.com/@mbenna?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Mike Benna</a> on <a href="https://unsplash.com/s/photos/pipeline?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a>
</div>

<h2 id="떼려야-뗄-수-없는-관계-단말과-서비스">떼려야 뗄 수 없는 관계, 단말과 서비스</h2>

<p>안녕하세요. 모빌리티 플랫폼 그룹 - 모비딕 팀의 스팍입니다.</p>

<p>쏘카가 서비스를 제공하기 위해서는 <strong>차량의 상태 정보</strong>가 필수적입니다. 사용이 끝난 차량이 정상적으로 제 위치에 안전한 상태로 돌아왔는지 언제든지 확인할 수 있어야 합니다.</p>

<p>따라서 차량의 상태 정보를 수집하여 서버에 전달하며, 고객의 요청에 따라 차량을 제어해주는 장치가 필요합니다.</p>

<p><img src="/img/iot-pipeline-1/pipeline_concept.jpg" alt="" width="75%" height="75%" style="display: block; margin: 0 auto" /></p>

<hr />

<h2 id="잠깐-쏘카의-구형-단말을-돌아봅시다">잠깐 쏘카의 구형 단말을 돌아봅시다</h2>

<p>서비스 초기부터 쏘카는 차량 내에 서비스를 위한 단말을 장착하여 사용하고 있었습니다(편의상 구형 단말이라 부르겠습니다). 그리고 서비스가 급격하게 성장하던 시절에도 이 단말은 그럭저럭 제 역할을 해주었죠.</p>

<p>이 구형 단말이 개발될 당시에는 운영 편의성을 위한 적합한 기술들이 아직 등장하기 전이었습니다. 따라서 단말을 제어할 때는 단말을 식별할 수 있는 고유번호인 전화번호를 이용하여 SMS 메시지를 통해 제어하였고, 단말이 데이터를 보낼 때는 웹서버에 데이터를 보내듯 HTTP로 데이터를 전달하였습니다.</p>

<p>이러한 구형 단말은 잠재적인 문제를 갖고 있었습니다. 그중 몇 가지를 꼽아보자면 다음과 같습니다.</p>

<ul>
  <li>SMS의 특성상 단말에 명령이 도달하는 데 시간이 많이 소요됩니다. 게다가 이 시간은 모든 지역에서 동일하지 않고 서울에서 멀어질수록 오래 걸리는 경향이 있습니다.</li>
  <li>데이터 수집을 HTTP로 하다 보니 이를 위한 웹서버가 필요합니다.</li>
  <li>데이터 전달 요청이 급증하면서 서버에 부하가 걸리면 데이터 수집에 지연이 발생합니다.</li>
</ul>

<p><img src="/img/iot-pipeline-1/old_device_arch.jpg" alt="" width="75%" height="75%" style="display: block; margin: 0 auto" /></p>

<hr />

<h2 id="이렇게-된-이상-새로운-단말을-만든다">이렇게 된 이상 새로운 단말을 만든다!</h2>

<p>이러한 문제를 해결하기 위해 새로운 단말을 만들기로 하였습니다.</p>

<p>새로운 단말을 만들 때 기존 단말이 갖고 있던 한계점과 문제를 보완하기 위해 아래와 같은 요구사항들을 세웠습니다.</p>

<ul>
  <li>HTTP를 통한 단말 데이터 수집을 더는 않는다. -&gt; 단말 메시지보다 HTTP 프로토콜이 더 많은 네트워크 자원을 소모해야 할 이유가 없음.</li>
  <li>SMS를 통한 차량 제어를 더는 하지 않는다. -&gt; 메시지 도달 시간이 환경에 따라 다르고 발송할 때마다 비용이 발생하는 방식에서 탈피.</li>
  <li>데이터 전달이 급증할 때 유연하게 대응할 수 있어야 함 -&gt; 트래픽에 유동적으로 대응이 힘든 웹서버를 사용해서는 안 됨.</li>
</ul>

<p>해서, 위와 같은 요구사항에 맞춰 신규 단말은 <a href="https://ko.wikipedia.org/wiki/MQTT">MQTT</a> 프로토콜 기반의 통신 방식을 채택하였습니다.</p>

<p>MQTT를 단말 프로토콜로 선정한 이유는, 무엇보다 프로토콜 자체가 제한적인 IoT 기기에서 대용량의 데이터를 전송하기 위한 프로토콜로써 설계가 되었다는 점입니다.</p>

<p>그리고 Publisher/Subscriber 구조로 되어 있어 여러 단말에 메시지를 퍼트리거나 상태 정보를 수집하는 것도 직접 각각의 단말들에 P2P로 연결할 필요 없이 메시지 브로커의 중개를 따르면 되므로 네트워크 관리 측면에도 용이합니다.</p>

<p><img src="/img/iot-pipeline-1/MQTT_protocol_example_without_QoS.png" alt="출처:ko.wikipedia.org/wiki/MQTT" width="45%" height="45%" style="display: block; margin: 0 auto" /></p>

<p>마지막으로 MQTT는 국제 표준화된 (ISO 표준 ISO/IEC PRF 20922) 프로토콜이므로 별도로 메시지 브로커를 개발할 필요 없이 이미 존재하는 수많은 메시지 브로커 중 하나를 선택하여 사용하면 된다는 것도 장점입니다.</p>

<p>MQTT를 지원하는 메시지 브로커는</p>

<ul>
  <li><a href="https://mosquitto.org/">mosquitto</a></li>
  <li><a href="https://vernemq.com/">VernaMQ</a></li>
  <li><a href="https://www.hivemq.com/">HiveMQ</a></li>
  <li><a href="https://www.rabbitmq.com/">RabbitMQ</a></li>
</ul>

<p>정도가 있습니다.</p>

<p>하지만, 위에 나열된 MQTT 브로커들을 직접 운영한다고 하면 아래와 같은 고민에 부딪히게 됩니다.</p>

<ul>
  <li>메시지 브로커들을 직접 관리해야 하므로 운영에 대한 부담이 늘어납니다.</li>
  <li>대부분의 브로커가 스스로에 대한 모니터링 방법은 제공하지만 어떤 단말이 연결 중인지에 대한 정보까지는 제공해주지 않습니다.</li>
  <li>서비스 안정성을 위해서 클러스터링 할 수 있어야 하지만 이것을 지원해주지 않는 브로커도 많습니다.</li>
  <li>차량 제어라는 특수성을 만족하기에는 보안 측면에서 부족한 부분이 있습니다.</li>
</ul>

<p>그리하여 저희 팀에서는 직접 브로커를 관리 및 운영하기보다는, 클라우드 관리형 메시지 브로커 서비스인 <a href="https://aws.amazon.com/ko/iot-core/">AWS IoT Core</a>를 사용하기로 하였습니다.</p>

<hr />

<h2 id="새-술은-새-부대에-aws-iot-core">새 술은 새 부대에. AWS IoT Core.</h2>

<p>AWS IoT Core를 쓰면 여러 이점을 얻을 수 있습니다.</p>

<ul>
  <li>관리되는 서비스이므로 운영에 있어 수기로 작업해줘야 하는 부분이 줄어듭니다.</li>
  <li>IoT 단말들을 정책기반으로 운영할 수 있습니다.</li>
  <li>어떤 단말들이 연결되었는지 확인이 가능합니다.</li>
  <li>메시지 브로커에 대한 모니터링 역시 손쉽게 가능합니다.</li>
</ul>

<p><img src="/img/iot-pipeline-1/new_device_arch.jpg" alt="" width="75%" height="75%" style="display: block; margin: 0 auto" /></p>

<p>AWS IoT Core를 쓸 때 서비스를 운영하는 입장에서 가장 주요한 부분은 “관리되는 서비스”라는 점입니다. 카셰어링 서비스의 특성상 시간이나 시즌마다 데이터양이 크게 달라지는 이슈를 가지고 있습니다. 그리고 서비스에 부하가 걸리더라도 항상 단말은 명령 수신과 상태 보고에 있어 준비된 상태를 유지해야 합니다. 단말이나 통신 환경에 문제가 없을지라도 브로커의 상태가 불안정하면 서비스의 운영 안정성에 크게 영향을 미치므로 관리되는 서비스가 주는 이점은 강력하다 하겠습니다.</p>

<p>특히나 AWS IoT Core를 사용하면서 강력한 도구가 되어주는 것이 <a href="https://docs.aws.amazon.com/ko_kr/iot/latest/developerguide/provision-wo-cert.html">Fleet provisioning</a>이라는 것입니다. 메시지 브로커에 인증받지 않은 단말이나 시스템이 접속하여 멋대로 메시지를 구독 혹은 발행하게 되면 보안 측면에서 데이터 유출이 일어나거나 차량 제어 측면에서 적절치 못한 제어를 통해 고객의 안전이 위협받을 수도 있습니다.</p>

<p>따라서 메시지 브로커에 대한 접근 제한이 필수라 하겠는데, 수천 대가 넘어가는 단말들에 대해 일일히 접근 권한을 부여하고 관리하는 것도 큰일입니다. 이를 Fleet provisioning 기능을 통해 인증서와 보안정책 간의 결합을 통해 매우 편리하게 관리할 수 있게 되었습니다.</p>

<hr />

<h2 id="aws-iot-core-쓰면-끝">AWS IoT Core 쓰면 끝?</h2>

<p>AWS IoT Core를 활용하여 단순히 차량 데이터를 수집을 하는 것에만 머무르기엔 아쉽습니다. 여기서 더 나아가 각 부서(도메인)의 관점과 필요에 따라 수집된 데이터를 유연하게 활용한다면 더 좋을 것입니다. 기존에는 단말 데이터를 전부 DB에 저장하여 활용하는 방식을 사용했습니다. 그러나 이 방식은 DB 부하를 불러온다는 단점을 가지고 있습니다.</p>

<p>모비딕 팀에서는 이 단점을 극복하기 위해 AWS IoT Core로부터 수집한 데이터를 <a href="https://aws.amazon.com/ko/msk/">Amazon MSK</a>를 활용하여 흘려보내고 있습니다. 이러한 구조로 인해 데이터가 필요한 각 비즈니스 영역에서 MSK를 구독하는 컨슈머를 만들기만 하면 수집된 차량 상태 데이터를 활용할 수 있게 됩니다.</p>

<p><img src="/img/iot-pipeline-1/aws_iot_arch.jpg" alt="" width="75%" height="75%" style="display: block; margin: 0 auto" /></p>

<p>여기까지 쏘카에서 사용 중인 단말들을 더 빠르게 제어하고 더 많은 데이터를 더 안정적으로 수집하기 위한 구조를 만들어 내는 과정을 설명해 드렸습니다.</p>

<p>다음에는 실제 Amazon MSK를 구축할 때 마주쳤던 문제들을 해결하는 과정에서 얻어진 글로 찾아뵙겠습니다.</p>


        </div>
        
        <hr>
        <div class="clearfix">
          
          <a class="btn btn-primary float-left" href="/data/2021/12/28/data-engineering-team-onboarding.html" data-toggle="tooltip" data-placement="top" title="쏘카 신입 데이터 엔지니어 디니의 4개월 회고">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/mobility/2022/01/18/socar-mobility-lab-battery-management-process-second-stage.html" data-toggle="tooltip" data-placement="top" title="자동차 배터리를 더 소중하게 공학적으로 관리하기 #2">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          
        </div>
        <div>
          <p class="recuit">쏘카는 언제나 쏘카 서비스를 함께 만들며 기술적인 문제를 함께 풀어나갈 능력있는 개발자/디자이너/기획자/데이터 사이언티스트 등을 모시고 있습니다. 자세한 내용은 <a href="https://bit.ly/SOCAR-RECRUIT">쏘카 채용공고 페이지</a>를 확인 부탁드립니다 :)</p>
        </div>
      </div>
    </div>
    <!-- utterance comments -->
    <script src="https://utteranc.es/client.js"
        repo="socar-inc/techblog-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
    </script>
  </div>

<script>
  // ref https://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '#toc',
    contentSelector: '.post-content',
    headingSelector: 'h1, h2, h3',
    hasInnerContainers: true,
    collapseDepth: 6,
    linkClass: 'toc-link'
  });


  $(window).on('scroll', function() {
      let scrollTop = $(window).scrollTop()
      let scrollBottom =  scrollTop + $(window).height()
      let contentOffsetTop = $(".post-content").offset().top
      let contentOffsetBottom = contentOffsetTop + $(".post-content").height()
      let elementHeight = $(".post-content").height(); 

      if ((scrollTop < contentOffsetTop) || (scrollBottom >= contentOffsetBottom)) {
        // $('.toc').css('visibility', 'hidden')
        $('.toc').addClass("toc-hidden")
      }
      else if (scrollTop >= contentOffsetTop) {
        $(".toc").removeClass("toc-hidden")
      }
  });
</script>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-9 mx-auto">
        <ul class="list-inline text-center">
          
          
          
          <li class="list-inline-item">
            <a href="https://www.facebook.com/socarsharing">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; SOCAR 2023 | tech_branding@socar.kr</p>
      </div>
    </div>
  </div>
</footer>


  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>
<script src="/assets/scripts.js"></script>
<script src="/assets/mermaid-8.2.3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30551922-27"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-30551922-27');
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MZ79TFM');</script>
<!-- End Google Tag Manager -->


</body>

</html>

---
layout: post
title: "차량 방전 방지 알림 개발기"
subtitle: "쏘카 모빌리티Lab - 자동차 시동 배터리를 잘 관리하기 위한 여정 - 두 번째"
date: 2021-11-30 09:00:00 +0900
category: mobility
background: '/assets/images/tyler-clemmensen-c5e6HmUTZDk-unsplash.jpg'
author: charlie
comments: true
tags:
  - mechanical engineering
  - chemical engineering
  - data
---

안녕하세요. 쏘카 모빌리티Lab의 찰리입니다. [지난 글](https://socarcharlie.github.io/mobility/2021/07/20/socar-mobility-lab-battery-management-process-first-stage.html)에서는 10,000대가 넘는 차량을 운영하는 쏘카에서, 차량의 배터리 상태 관리를 위한 공학적인 접근 방식과 해결 방법에 대해 다뤘습니다. 이번 글에서는 배터리 방전을 사전에 막기 위해 알람 서비스를 도입하고, 운영에 도입한 내용을 공유해보고자 합니다. 다소 전문적인 지식이 필요했던 지난번 글에 비해 이번 글은 누구나 쉽게 읽으실 수 있을거라 생각합니다.

<br>

## 목차

- 의도치 않은 실수들로 생기는 배터리 방전
- 시나리오별 차량 전류 측정하기
- 차량 방전 상태 판단하기
- 수집과 판단 시스템 구축하기
- 실제로 알림은 어떻게 보내나요?
- 조금만 더 세심하게 다뤄주세요. 다같이 쓰는 차니까요.



<br />

## 의도치 않은 실수들로 생기는 배터리 방전

[지난 글](https://socarcharlie.github.io/mobility/2021/07/20/socar-mobility-lab-battery-management-process-first-stage.html)을 보면 쏘카에서 일어나는 배터리 방전의 60% 이상이 고객의 사용 습관과 밀접하다고 말씀 드렸습니다. 그러나 배터리 방전을 고객이 의도적으로 내지는 않습니다. 대부분은 어떤 상황에서 방전이 되는지 잘 모르시기 때문에 일어나곤 합니다.

저 역시 의도치 않게 쏘카 차량의 방전을 일으킬만할 경험이 있습니다. 제가 보유하고 있는 차는 시동 버튼을 두 번 눌러 시동을 완전히 종료시키는 반면, 쏘카 차량 (현대/기아차, Jeep)은 시동 버튼을 한 번만 눌러도 시동 종료가 이루어졌습니다. 기어 상태도 시동을 종료하면 자동으로 주차 모드로 바뀌는 제 차와 달리 기어 봉을 직접 P로 옮겨주어야 했습니다. 사실 자동 변속기 차량에서 시동을 P에 두고 시동을 종료하는 일은 대단히 당연합니다. 단지 제가 익숙한 방식과 조금 달랐기에 이런 실수를 저질렀고, 그 결과 차량 반납 불가의 메시지를 받았습니다. 저와 비슷한 상황에 놓였던 고객과 핸들러 입장에서 가시동이나 기어봉 P가 아닌 D혹은 R 모드 중 강제 반납으로 인한 방전상황 노출이 대단히 쉬운 일임을 깨닫게 된 순간이었습니다.

주위에 비슷한 사례가 있나 싶어 지인들에게 물어보니, 쏘카 패스를 구독하는 저의 친구 역시 비슷한 경험이 있었습니다. 몹시 더운 여름 어느날 주차 중에 에어컨을 켜고 싶어서 가시동 상태로 송풍기를 열심히 돌리면서 노래도 들었다고 합니다. 그렇게 한 시간 정도가 지났고 차를 다시 움직여 이동하려고 하는데 시동이 걸리지 않았다고 합니다. 친구는 가시동 상태에서 송풍기를 돌리고(에어컨 컴프레셔는 멈춰있어서 바람만 나왔을텐데) 차량 스피커로 음악을 들으면 필요한 전력을 모두 차량 배터리에서 가져 온다는 사실을 몰랐습니다.

이 외에도 고객이 전혀 의도하지 않았지만 차량의 전원관리에 나쁜 영향을 미칠 수 있는 차량 운용으로 인해 방전이 생기는 경우는 다양할거라 생각했습니다. 어떻게 해야 고객께서도 방전을 겪지 않아 기분이 좋고 쏘카도 관리 이슈를 줄일 수 있을까요?

저는 이렇게 생각했습니다.

> "고객께서 실수하지 않도록 우리가 도와드리자. 알림을 보내드리면 상황 인지를 빨리 하실 수 있겠지?"

결론은 고객에게 어떤 형태로든 <span style="color:#01b0f0;"><b>"알림을 드리자!"</b></span> 였습니다.



## 시나리오별 차량 전류 측정하기

```
* 하디 코멘트

이 부분 읽어보시고 더 채울부분 채워주시면 되겠습니다!
```

고객에게 방전될 수 있는 상황임을 알리는 알림을 보내기 위해서는, 먼저 차량이 방전 상태에 있는지 알아야 합니다. 쏘카 차량에는 관제 장치가 붙어있는데, 이 장치로부터 차량 상태에 대한 데이터를 주기적으로 받을 수 있습니다. 이 때 "어느 정도의 주기"로 데이터를 수집할지를 정해야 합니다. 주기가 너무 늦으면, 방전 상태를 너무 늦게 판단하게 되고, 너무 빠르게 하면 알람이 너무 자주가게 됩니다. 따라서 이 적당한 주기를 잘 찾는 것이 중요합니다.

이를 위해 가장 먼저 한 일은 차량 방전이 일어날만한 시나리오를 생각해보고, 각 시나리오별 전류가 어느정도로 빨리 소모되는지 측정하는 일이었습니다. 차량 별로 전류 소모 속도가 다르기 때문에...

처음에는 차량 방전이 일어나기 쉬운 사용 시나리오를 최대한 생각해보았습니다. 가시동 중 노래 듣기, 송풍기(1~n단까지 모두 다른 케이스로 가정했음), 전조등, 미등, 상향등, 경고등, 실내등 등등 모든 전력 소모 및 방전 요소를 모두 조합한 시나리오를 세웠고 **시나리오별로 전류가 얼마정도 소모되는지 모두 측정**하기로 했습니다.

전류 측정은 초등학교 시절 한번즈음 모두가 거쳐갔을 라디오 조립키트의 전류 측정보다 아주 조금 어려운 정도입니다 (~~쉽다는 말을 어렵게 해 보았습니다.~~). 

직접 실험을 해보고 싶으신 분도 계시리라 생각하여 측정 법에 대해 설명 드리겠습니다.

1. 우선 배터리의 - 단자에 연결된 터미널을 제거합니다.
2. 배터리가 제거되는 순간 자동차에 연결된 IBS단자 (Intelligent Battery Sensor) 는 초기화 됩니다. 이 센서는 배터리의 상태와 관련된 값을 수집하는 센서인데 이 센서의 초기화 부분은 차량 제조사와 차종마다 모두 상이하므로 다루지 않도록 하겠습니다. 차량 제조사 메뉴얼에 보면 이 센서의 초기화와 관련된 내용이 상세히 적혀 있으니 참고하시면 좋습니다.
3. 전력계의 모드를 전류 측정으로 전환 합니다. 
4. 제거된 터미널에 전력계의 양극부를 연결하고, 배터리의 - 단자에는 전력계 음극부를 연결합니다. 이때 측정기의 리드 케이블은 클립형이 좋으며 길고 튼튼할 수록 좋습니다. 측정 할 때는 보닛을 닫아두는게 좋기 때문입니다.
5. 잘 연결이 되었다면 전력계에 전류 값이 표시됩니다.

위의 설명은 고전적인 측정기를 사용하는 방법입니다. 요즈음에는 블루투스로 연동하여 핸드폰으로 값을 받을 수 있는 전류 측정기가 있어서 측정이 비교적 쉽습니다. 블루투스 전류 측정기의 자동차 단자 연결법도 위와 동일합니다.

측정기 연결이 잘 되었다면 미리 세워둔 시나리오별로 전류 소모의 변화를 모두 기록합니다. 다양한 차종에 대해 실험하다 보니 하루에 끝내기는 어려웠고 실험 완료까지 수 일이 걸렸습니다. 측정이 완료된 시점에서 보니 생각보다 방전을 일으키키 정말 쉬운 물건이 자동차구나 싶었습니다. 시나리오 중 한가지 예를 아래에 공유드리도록 하겠습니다. 실험 값과 차종은 모두 예시입니다.

|                 | Avg[A] | Max[A] | 검출 여부 |                                         비고 |
| --------------- | :----: | :----: | :-------: | -------------------------------------------: |
| 실내등(개당)    |  0.6   |        |     △     |                     문 열림 상태로 간접 추론 |
| ACC1            |  2.1   |   3    |     O     |                                              |
| ACC2            |  7.5   |   12   |     O     |                                              |
| 송풍기1단       |   3    |        |     X     |                                              |
| 송풍기2단       |  4.2   |        |     X     |                                              |
| 송풍기3단       |  6.8   |        |     X     |                                              |
| 송풍기4단       |  11.2  |        |     X     |                                              |
| 라이트1단       |  0.8   |        |     △     |                           단계는 나오지 않음 |
| 라이트2단       |  8.8   |        |     △     | 단계는 나오지 않음, 차종별로 ACC2부터 가능함 |
| 라이트3단(High) |  9.8   |        |     △     | 단계는 나오지 않음, 차종별로 ACC2부터 가능함 |
| 비상등          |   3    |  5.5   |     X     |                                              |

그리고 구현 가능한 시나리오는 다음과 같았습니다.

```
일반적인 시나리오

S1. 시동 OFF + 문열림: 0.6A 소모
S2. ACC1 단독: 2.1A 소모
S3. ACC2 단독: 7.5A 소모
S4. ACC1 + Light 1단 (흔한 유형): 2.9A 소모
S5. ACC2 + Light 2단 (흔한 유형): 16.3A 소모
S6. ACC2 + 송풍기 2단 (흔히 말하는 차박): 11.7A 소모

최악의 시나리오

SW. ACC2 + 실내등2개 (문 앞뒤열림) + 송풍기 4단계 + Light 3단 + 비상등 +핸드폰 충전기: 32.7A 소
```



## 차량 방전 상태 판단하기

```
* 하디 코멘트

이 부분 읽어보시고 더 채울부분 채워주시면 되겠습니다!

- 방전 전후 상황과 일반 상황의 데이터 패턴은 어떻게 다른지?
- 과거 데이터를 실제로 방전 패턴에는 어떤 시나리오들(혹은 데이터 패턴)이 있었는지?
- 패턴을 발견하고 룰을 세우는 과정은 어떠했는지?
- 등등...
```

그러나 실험 데이터로 얻어진 값은 시나리오를 만들기 위한 참고 자료일 뿐! 쏘카에서 실제 사용하는 운영 데이터를 사용해서 상황을 검출할 수 있게 다듬어진 데이터는 아닙니다. 과거 데이터를 통해 어떤 시나리오가 가장 빈번하게 일어나는지 파악도 해야합니다.

쏘카 차량에는 관제 단말기가 부착되어 있고, 이 단말기로부터 차량 주행과 관련된 데이터를 주기적으로 수집하고 있습니다. 수집하는 데이터 중에는 시동/가시동/정지 여부, 전조등 켜짐/꺼짐 여부, 전압 정보 등등 고객님의 차량 운용 패턴과 관련된 데이터도 있습니다. 따라서 방전 관련 CS 콜이 들어온 시간을 전/후로 주행 정보를 살펴보면 문제 발생을 일으키는 주요한 운용 패턴을 발견할 수 있습니다.

실험과 데이터를 보기 전에는 고객이 단순히 전조등만 켜 놓았거나, 송풍기만 켜 놓았다거나, 실내등만 켜두는 등의 단일 조작 위주의 시나리오가 많을거라 생각했습니다. 그러나 실험과 데이터를 통해, 생각과는 달리 꽤나 다양한 요소가 결합된 시나리오가 많다는 사실을 알 수 있었습니다. 따라서 짧은 주기로 알림을 주어 고객이 최대한 빠르게 현 상황을 인지하고 벗어나도록 유도해야겠다는 생각이 들었습니다.

<br>

## 수집과 판단 시스템 구축하기

```
* 하디 코멘트

데이터 수집주기부터, 알고리즘, 파이프라인 구축, 배포 ... 등에 대한 내용이 들어가면 좋을거 같습니다.
또 각 의사결정과 판단에 대한 근거도 적어주시면 좋을거 같습니다. (이건 개인적으로 엔지니어적인 역량을 가장 잘 드러내는 부분이라 생각합니다.)
물론 ... 이 부분에 대해 할말이 없드시거나 너무 힘드시면 위 단락과 합치셔도 무방할거 같습니다.
```

![](/img/socar-mobility-lab-battery-management-process-second-stage/Figure-2.png){: width="90%" height="90%" style="display: block; margin: 0 auto"}

<p align="center"> [그림 2] 실행 프로세서의 순서도 </p>

<br>

## 실제로 알림은 어떻게 보내나요?

언제 어떻게 알림을 보낼지에는 **비용의 문제**가 수반됩니다. 어떤 방법이든 알림 한번을 보내는 데에 들어가는 비용이 있고 이 비용이 1만대로 확장된다면 결코 작지 않습니다. 알림을 통한 관리 이득과 고객 경험 이득이 소모 비용에 묻히면 도리어 손해이므로 실제 운영부서와 같이 계산을 해 보았습니다. 계산에 고려된 요소는 다음과 같습니다.

1. 시나리오별 회생 불능 방전에 도달하기까지 걸리는 시간
2. 시나리오별 빈도 (과거 사례 기반)
3. 고객이 차량 정차 후 정차된 차량으로 돌아오기 어려울 정도로 멀리 떠나기 까지 걸리는 시간 
4. 알림 방식 별 소모 비용
5. 방전으로 인한 긴급 출동 및 작업 비용
6. 기존 사용 채널과 인프라의 활용 가능 여부

쏘카의 운영 노하우와 직결된 요소가 많군요. 실제 운영 데이터를 공개할 수 없지만 예시로 보여드린 실험 데이터와 운영 예시 데이터를 바탕으로 비용 정리를 어떻게 해 나갔는지 풀어보겠습니다. 60Ah 배터리를 사용하는 차량을 예로 들겠습니다.

1. 시나리오 별 회생 불능 방전에 도달하기까지 걸리는 시간

   - 시나리오 별, 실 평균 용량 기준 버틸 수 있는 시간(hour)의 정의

       - 정격 용량의 절반에 도달하기까지 걸리는 시간으로, 이 이하의 영역에서는 배터리 상태 복원이 물리적으로 어려워집니다.

   * 각 시나리오는 글 위에서 정의한 S1~S6 및 SW를 의미합니다.
     
     | SW   | S1   | S2   | S3   | S4   | S5   | S6   |
     | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
     | 0.5  | 27.0 | 7.7  | 2.2  | 5.6  | 1.0  | 1.4  |

2. 시나리오별 빈도 (과거 사례 기반, 순서에 따라 정렬함)

   ```
   * 하디 코멘트
   
   시나리오별 빈도가 어떤 점에서 중요한건가요? 이게 실제로 알람 횟수에 어떻게 반영되는건가요?
   ```

   - S1의 연속 4회 이상 발생

   - S5

   - S4

3. 고객이 차량을 주차시킨 후 개인 용무로 인해 정차된 차량으로 돌아오기 어려울 정도로 멀리 떠나기 까지 걸리는 시간 → 보통 10~15분 (CS 콜 분석)

    ```
    * 하디 코멘트
    
    이 요소 역시 어떤 이유로 들어가게된건지 설명해주시면 좋을거 같습니다.
    ```

4. 알림 방식 별 소모 비용 → 방식 마다 상이하나 건당 5원~10원미만 추산함

5. 방전으로 인한 긴급 출동 및 작업 비용 → 밝힐 수 없음.

6. 기존 사용 채널과 인프라의 활용 가능 여부 → 유사 운영 시스템 선례가 있어 가능함.

위의 데이터가 실제 값은 아니지만 같은 절차로 다양한 시나리오에 대한 데이터를 도출했고, 결과를 바탕으로 실제 활용할 운영부서와 수 차례 검토를 실시했습니다. 결국 운영 비용의 최적화와 관련된 문제를 풀어야 하기 때문에 "몇 회, 몇 번 발송 해야하는가?" 에 대해 제일 많이 시뮬레이션 해보았고, 모든 요소를 고려하여 내린 결론은 아래와 같았습니다.

1. 기존 채널을 활용 가능한 카카오톡 알림을 활용함
2. 10분에 1회 발송하며 그 주기는 성과를 보면서 증/감 함

<br>

## 조금만 더 세심하게 다뤄주세요. 다같이 쓰는 차니까요.

위의 기준으로 쏘카는 본 서비스를 2021년 2월부터 투입했습니다. 성과를 간략히 말씀드리면, 동기 대비 이용건수가 8% 늘어난 상황에서 (2021년 n월 기준) 긴급 출동 건수 35% 감소가 이루어졌으며 방전 비율도 절반 정도 감소 (2021년  n월 기준) 했음을 확인했습니다 (회사의 영업 기밀이기에 자세한 기준을 공개하기 어려운 점 양해 부탁드립니다.).

본 아이디어의 기본 개념은 "고객이 실수할 확률 자체를 낮추어드리자" 입니다. 누구도 쏘카의 차량을 일부러 고장내고 싶지 않으리라 생각합니다. 단지 자동차에 대한 경험적 이해가 아직 부족해서, 혹은 피할 수 없는 상황에 놓여서, 어쩌면 쏘카 정비의 미진한 점으로 인한 일들이 있었겠죠. 이런 상황에 놓이지 않도록 미리 도움을 드리는 일도 쏘카가 기술적으로 해결할 일이라고 생각합니다.

쏘카는 **누구나** 이용할 수 있고, **누구나** 이용하는 '**카-셰어링**' 서비스 입니다. 따라서 쏘카 차량의 주인은 <span style="color:red;"><b>"쏘카"</b></span>가 아닌  <span style="color:#01b0f0;"><b>"여러분 모두"</b></span> 입니다. 쏘카는 단지 모두가 사용하는 차량에 날개를 달아주는 도우미라고 생각합니다. 앞으로도 좋은 날개를 달기 위해 고객의 주행 환경과 경험 개선을 위한 다양한 기술기반 아이템을 많이 발굴하도록 노력하겠습니다. 쏘카를 이용해주시는 쏘카 차량의 주인이신 여러분들 께서도 여러분들의 차량을 조금만 더 아껴주시면 감사하겠습니다.

> **쏘카의 모빌리티Lab**은 모두 높은 수준의 기계 공학 지식을 보유한 인력으로 이루어졌으며, 쏘카의 풍부한 차량 데이터에 기계 공학 지식을 녹여 운영에 필요한 최적 솔루션을 만들고 있습니다. (우리에게 힘을 더해주실 우수한 분을 모시고 있습니다. 언제든지 지원해주세요)




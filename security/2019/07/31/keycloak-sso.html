<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    Keycloakë¥¼ ì´ìš©í•œ SSO êµ¬ì¶•(web + wifi + ssh) - SOCAR Tech Blog
    
  </title>

  <meta name="description" content="ID í•˜ë‚˜ë¡œ ë°±ì˜¤í”¼ìŠ¤ + Wifi + ì„œë²„(SSH)ì— ì ‘ì† ê°€ëŠ¥í•œ í™˜ê²½ êµ¬ì¶•í•˜ê¸°">

  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://tech.socarcorp.kr/security/2019/07/31/keycloak-sso.html"/>
  <meta property="og:title" content="Keycloakë¥¼ ì´ìš©í•œ SSO êµ¬ì¶•(web + wifi + ssh)"/>
  <meta property="og:description" content="ID í•˜ë‚˜ë¡œ ë°±ì˜¤í”¼ìŠ¤ + Wifi + ì„œë²„(SSH)ì— ì ‘ì† ê°€ëŠ¥í•œ í™˜ê²½ êµ¬ì¶•í•˜ê¸°"/>
  <meta property="og:site_name" content="SOCAR Tech Blog"/>
  <meta property="og:image" content="https://tech.socarcorp.kr/assets/images/zhen-hu-ppPciOz6Cbs-unsplash.jpg"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="Keycloakë¥¼ ì´ìš©í•œ SSO êµ¬ì¶•(web + wifi + ssh)"/>
  <meta name="twitter:description" content="ID í•˜ë‚˜ë¡œ ë°±ì˜¤í”¼ìŠ¤ + Wifi + ì„œë²„(SSH)ì— ì ‘ì† ê°€ëŠ¥í•œ í™˜ê²½ êµ¬ì¶•í•˜ê¸°"/>
  <meta name="twitter:image" content="https://tech.socarcorp.kr/assets/images/zhen-hu-ppPciOz6Cbs-unsplash.jpg"/>


  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="/assets/main.css">

  <link rel="canonical" href="https://tech.socarcorp.kr/security/2019/07/31/keycloak-sso.html">
  <link rel="alternate" type="application/rss+xml" title="SOCAR Tech Blog" href="/feed.xml">
  <link rel="icon" type="image/png" href="/assets/icon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icon/favicon-96x96.png">
</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">SOCAR Tech Blog</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">ğŸ  Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">âœï¸ Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/categories">ğŸ“” Categories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/tags">ğŸ· Tags</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/authors">âœğŸ» Authors</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/assets/images/zhen-hu-ppPciOz6Cbs-unsplash.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-9 col-md-9 mx-auto">
          <div class="post-heading">
            <h1 class="post-title">Keycloakë¥¼ ì´ìš©í•œ SSO êµ¬ì¶•(web + wifi + ssh)</h1>
            
            <h2 class="subheading">ID í•˜ë‚˜ë¡œ ë°±ì˜¤í”¼ìŠ¤ + Wifi + ì„œë²„(SSH)ì— ì ‘ì† ê°€ëŠ¥í•œ í™˜ê²½ êµ¬ì¶•í•˜ê¸°</h2>
            
            <div class="post-meta">
              
              
                
                <span class="author"><a href="/authors#ë„ë§ˆ"><img src="/assets/authors/dorma.jpeg">ë„ë§ˆ</a></span>
              
                <br>
                <span class="date">2019-07-31</span>
                <br>
                <span class="category"><a href="/categories#">security</a></span> 
                <br>
              
                <span class="tag"><a href="/tags#keycloak">keycloak</a></span>
              
                <span class="tag"><a href="/tags#sso">sso</a></span>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="toc toc-hidden" id="toc">
    </div>
    <div class="row">
      <div class="col-lg-9 col-md-9 mx-auto">
        <div class="post-content">
        <div class="photo-copyright">
Photo by <a href="https://unsplash.com/@zhenhu2424?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Zhen Hu</a> on <a href="https://unsplash.com/search/photos/lock?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a>
</div>

<p>ì´ë²ˆì— ì˜ì¹´ì—ì„œ ì‚¬ë‚´ ë³´ì•ˆ ê°•í™”ë¥¼ ìœ„í•´ SSO(Single Sign-On)ë¥¼ êµ¬ì¶• í•˜ì˜€ìŠµë‹ˆë‹¤.<br />
ì˜íŒ¸ê³¼ íŒŒíŠ¸ë„ˆë“±ì´ ì—…ë¬´ì— ì‚¬ìš©í•˜ëŠ” ê´€ë¦¬ì‹œìŠ¤í…œ(web) ë° wifi, ssh ì ‘ì† ì¸ì¦ì„ 1ê°œì˜ IDë¡œ ê´€ë¦¬ í•˜ë„ë¡ í•˜ëŠ” ê²ƒì´ ëª©ì ì…ë‹ˆë‹¤.</p>

<p>ì •ë¦¬ëœ ìš”êµ¬ ì‚¬í•­ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ol>
  <li>Web ì‚¬ì´íŠ¸ ì¸ì¦.(Spring ë² ì´ìŠ¤ ì‚¬ì´íŠ¸)</li>
  <li>Wifi ì¸ì¦</li>
  <li>SSH ì¸ì¦(+ Sudo ì¸ì¦)</li>
  <li>2ì°¨ ì¸ì¦ (OTP) ì§€ì›</li>
  <li>ìœ ì—°í•œ ê¶Œí•œ ì„¤ì •(Authorization)</li>
</ol>

<p>Identity Providerë¡œ ì—¬ëŸ¬ ìœ ë£Œ ì†”ë£¨ì…˜(<a href="https://www.gluu.org/">Gluu</a>, <a href="https://developers.google.com/identity/">Google Identity Platform</a> ë“±)ë„ ê²€í†  í•˜ì˜€ìœ¼ë‚˜ ì„¤ì¹˜í˜• + ì˜¤í”ˆì†ŒìŠ¤ë¡œ ë¬´ë£Œë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ <a href="https://www.keycloak.org/"><code class="highlighter-rouge">Keycloak</code></a>ìœ¼ë¡œ êµ¬ì¶•ìœ¼ë¡œ ë°©í–¥ì„ ì¡ì•˜ìŠµë‹ˆë‹¤.</p>

<p>Wifi ì¸ì¦(<a href="https://freeradius.org/modules/?s=ldap&amp;mod=rlm_ldap">FreeRADIUSì—ì„œ LDAP ëª¨ë“ˆ ì§€ì›</a>)ì´ë‚˜ sshì¸ì¦(<a href="https://www.tldp.org/HOWTO/archived/LDAP-Implementation-HOWTO/pamnss.html">pam_ldap</a>)ì˜ ê²½ìš° OpenLDAPê³¼ ì—°ë™í•´ì„œ ì²˜ë¦¬ í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ìë£Œê°€ ë” ë§ì§€ë§Œ, Webê¸°ë°˜ìœ¼ë¡œ ìš´ìš© ê°€ëŠ¥í•œ ì‹œìŠ¤í…œì„ ë” ì„ í˜¸í•´ì„œ Keycloakì„ ì„ ì •í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. <del>í—˜í•œê¸¸ì„ ê°€ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</del></p>

<h2 id="ëª©ì°¨">ëª©ì°¨</h2>

<ul>
  <li>Keycloak ì´ë€?</li>
  <li>Keycloakìœ¼ë¡œ ìš”êµ¬ì‚¬í•­ì˜ ë‚´ìš©ì„ ì–´ë–»ê²Œ êµ¬í˜„í• ê¹Œ?</li>
  <li>ì„¤ì¹˜ ê³„íš ë° êµ¬ì„±</li>
  <li>Kubernetes(AWS EKS)ì— Keycloak ì„¤ì¹˜</li>
  <li>RADIUS ì„œë²„ ì„¤ì¹˜ ë° Keycloak ì—°ë™ ì„¤ì •</li>
</ul>

<hr />

<h2 id="keycloak-ì´ë€"><a href="https://www.keycloak.org/">Keycloak</a> ì´ë€?</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  - open source + ì„¤ì¹˜í˜•
  - OpenID / SAML ì§€ì›
  - Restful API ì§€ì› ë° ì»¤ìŠ¤í…€ API ì¶”ê°€ ê°€ëŠ¥
  - RedHatì—ì„œ ì§€ì›í•˜ëŠ” í”„ë¡œì íŠ¸
  - keycloak-gatekeeper ë“±ì„ ì´ìš©í•˜ë©´ Web ì‚¬ì´íŠ¸ ê¶Œí•œ ì²˜ë¦¬ë„ ìš©ì´
</code></pre></div></div>

<ul>
  <li>github: <a href="https://github.com/keycloak/keycloak">https://github.com/keycloak/keycloak</a></li>
  <li><a href="https://access.redhat.com/products/red-hat-single-sign-on">RedHat SSO</a>ì˜ ì˜¤í”ˆì†ŒìŠ¤ ë²„ì „</li>
</ul>

<hr />

<h2 id="keycloakìœ¼ë¡œ-ìš”êµ¬ì‚¬í•­ì˜-ë‚´ìš©ì„-ì–´ë–»ê²Œ-êµ¬í˜„í• ê¹Œ">Keycloakìœ¼ë¡œ ìš”êµ¬ì‚¬í•­ì˜ ë‚´ìš©ì„ ì–´ë–»ê²Œ êµ¬í˜„í• ê¹Œ?</h2>

<h3 id="1-web-ì‚¬ì´íŠ¸-ì¸ì¦">1. Web ì‚¬ì´íŠ¸ ì¸ì¦</h3>
<ul>
  <li>OpenID / SAML í”„ë¡œí† ì½œ ì§€ì› ë° Java client ì§€ì›</li>
  <li>reverse proxyë¡œ ë™ì‘í•˜ëŠ” <a href="https://github.com/keycloak/keycloak-gatekeeper">gatekeepr</a>ë¥¼ ì´ìš©í•´ Web Applicationì—ì„œëŠ” ì¸ì¦ / ê¶Œí•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ì§€ ì•Šê³ ë„ ì²˜ë¦¬ ê°€ëŠ¥</li>
</ul>

<h3 id="2-wifi-ì¸ì¦">2. Wifi ì¸ì¦</h3>
<ul>
  <li>ì‚¬ë‚´ì— Cisco ë¼ìš°í„°ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê³ , RADIUS í”„ë¡œí† ì½œì„ ì§€ì›í•˜ë¯€ë¡œ <a href="https://ko.wikipedia.org/wiki/RADIUS">RADIUS ì„œë²„</a>ë¥¼ êµ¬ì¶•í•˜ë©´ ê°€ëŠ¥</li>
  <li><a href="https://freeradius.org">FreeRADIUS</a>ì˜ <a href="https://wiki.freeradius.org/modules/Rlm_python">Python ëª¨ë“ˆ</a>ì—ì„œ keycloak APIë¥¼ í˜¸ì¶œí•´ì„œ ì¸ì¦ì„ ì²˜ë¦¬ í•˜ë©´ ê°€ëŠ¥</li>
</ul>

<h3 id="3-ssh-ì¸ì¦-sudo-ì¸ì¦">3. SSH ì¸ì¦(+ Sudo ì¸ì¦)</h3>
<ul>
  <li><a href="https://linux.die.net/man/5/sshd_config">sshd_config</a>ì„¤ì •ì—ì„œ UsePAM ì˜µì…˜ì„ í™œì„±í™” ì‹œí‚¤ê³  <a href="https://github.com/FreeRADIUS/pam_radius">pam_radius_auth.so</a>ë¥¼ ì‚¬ìš©í•´ RADIUS ì„œë²„ë¥¼ í†µí•´ì„œ ì¸ì¦ ê°€ëŠ¥</li>
</ul>

<h3 id="4-2ì°¨-ì¸ì¦-otp-ì§€ì›">4. 2ì°¨ ì¸ì¦ (OTP) ì§€ì›</h3>
<ul>
  <li>TOTP ì§€ì›</li>
  <li>Wifi ì¸ì¦ì‹œì—ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šì„ ì˜ˆì •ì´ë©°, SSH(+ sudo) ì¸ì¦ì‹œì—ëŠ” <a href="https://www.iana.org/assignments/radius-types/radius-types.xhtml">Access-Challenge + Reply-Message</a>ë¥¼ íšŒì‹ í•˜ë©´ <a href="https://github.com/FreeRADIUS/pam_radius">pam_radius_auth.so</a>ì—ì„œ ì‚¬ìš©ìì—ê²Œ ì¶”ê°€ ì…ë ¥ì„ ë°›ì„ ìˆ˜ ìˆìŒ</li>
</ul>

<h3 id="5-ìœ ì—°í•œ-ê¶Œí•œ-ì„¤ì •authorization">5. ìœ ì—°í•œ ê¶Œí•œ ì„¤ì •(Authorization)</h3>
<ul>
  <li>keycloakì˜ ê¶Œí•œ ì„¤ì •ì€ ìƒë‹¹íˆ(<del>ê³¼í•˜ê²Œ</del>) ìœ ì—°í•¨. (<a href="https://www.keycloak.org/docs/4.8/authorization_services/">ì°¸ê³ </a>)</li>
</ul>

<hr />

<h2 id="ì„¤ì¹˜-ê³„íš-ë°-êµ¬ì„±">ì„¤ì¹˜ ê³„íš ë° êµ¬ì„±</h2>

<ul>
  <li>Keycloakì€ <code class="highlighter-rouge">Kubernetes í´ëŸ¬ìŠ¤í„°</code>ì— ì„¤ì¹˜</li>
  <li>FreeRADIUSëŠ” <code class="highlighter-rouge">ë³„ë„ ì„œë²„ì— docker-compose</code>ë¡œ ì„¤ì¹˜(kubernetes í´ëŸ¬ìŠ¤í„°ì— ì„¤ì¹˜í•´ë„ ìƒê´€ ì—†ìŒ)
    <ul>
      <li>RADIUS í”„ë¡œí† ì½œì€ <code class="highlighter-rouge">UDP</code> Port2ê°œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.(default: 1812, 1813)</li>
      <li><del><code class="highlighter-rouge">UDP</code>ëŠ” AWSì—ì„œ Load Balancerë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</del> <a href="https://aws.amazon.com/ko/blogs/aws/new-udp-load-balancing-for-network-load-balancer/">ì…‹íŒ… ì™„ë£Œ í›„ .. ì–¼ë§ˆ ì „ë¶€í„° ì§€ì›ì‹œì‘</a></li>
    </ul>
  </li>
  <li>ëŒ€ëµì ì¸ êµ¬ì„±ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤</li>
</ul>
<div class="mermaid">
graph TD;
  subgraph Wifi
    CISCO_ROUTER[Cisco ë¬´ì„ ê³µìœ ê¸°]
  end

  subgraph Linux-Servers
    PAM_RADIUS[SSH ì ‘ì†]
  end

  subgraph Kubernetes-Cluster
    KEYCLOAK[Keycloak]
    WEB_APP[ì›¹ì„œë¹„ìŠ¤]
  end
  
  subgraph Other-Server
    FREE_RADIUS[FreeRADIUS]
  end

  CISCO_ROUTER--&gt;|RADIUS Protocol|FREE_RADIUS
  FREE_RADIUS--&gt;|HTTP API|KEYCLOAK
  WEB_APP--&gt;|HTTP API|KEYCLOAK
  PAM_RADIUS --&gt;|RADIUS Protocol|FREE_RADIUS
  USER --&gt;|ê´€ë¦¬ì‹œìŠ¤í…œ ì ‘ì†|WEB_APP
  USER --&gt;|Wifi ì ‘ì†|CISCO_ROUTER
  USER --&gt;|SSH ì ‘ì†|PAM_RADIUS
</div>

<hr />

<h2 id="kubernetesaws-eksì—-keycloak-ì„¤ì¹˜">Kubernetes(AWS EKS)ì— Keycloak ì„¤ì¹˜</h2>
<ul>
  <li><strong><a href="https://helm.sh/">helm</a>ì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</strong></li>
  <li>KeycloakëŠ” <a href="https://github.com/codecentric/helm-charts/tree/master/charts/keycloak">Helm Chart</a>ë¡œ ì œê³µ ë˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
  <li>ì„¤ì¹˜ì „ì— ì‚¬ì „ì— ì„¤ì •ë˜ì–´ì•¼ í•  ë‚´ìš©ë“¤ ì…ë‹ˆë‹¤.
    <ul>
      <li><a href="https://github.com/helm/charts/tree/master/stable/nginx-ingress">nginx-ingress</a> ì„¤ì¹˜</li>
      <li>AWSì˜ Route53ì— <code class="highlighter-rouge">*.mydomain.com</code>ì„ nginx-ingress ì„¤ì¹˜ í›„ ìƒì„±ëœ LBë¡œ ì—°ê²°.
        <ul>
          <li>Route53ì— <code class="highlighter-rouge">*.mydomain.com</code>ë¥¼ ì‚¬ìš©í•˜ë©´ ë“±ë¡ë˜ì§€ ì•Šì€ subdomainì€ ëª¨ë‘ ì´ê³³ìœ¼ë¡œ ì—°ê²°ë˜ê²Œ ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>RDSë¡œ MySQL ì‚¬ìš©.</li>
    </ul>
  </li>
  <li>helm installì‹œì—ëŠ” <a href="https://github.com/codecentric/helm-charts/tree/master/charts/keycloak#configuration">command lineì—ì„œ ë§¤ê°œë³€ìˆ˜ë¡œ ì„¤ì •</a>ì„ í• ìˆ˜ë„ ìˆì§€ë§Œ ë³€ê²½í•´ì•¼ ë  ê°’ë“¤ì´ ë§ìœ¼ë¯€ë¡œ <code class="highlighter-rouge">values.yaml</code>ì„ ìˆ˜ì •í•´ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>ì•„ë˜ëŠ” ì„¤ì¹˜í•œ í™˜ê²½ì— ë§ê²Œ ì„¤ì •í•˜ê¸° ìœ„í•´ <code class="highlighter-rouge">values.yaml</code>ì—ì„œ ìˆ˜ì •í•´ì•¼ í•  í•  ë¶€ë¶„ ì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>

<span class="na">keycloak</span><span class="pi">:</span>
<span class="nn">...</span>
  <span class="c1"># ì´ˆê¸° admin ID</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">keycloak</span>

  <span class="c1"># ì´ˆê¸° admin password</span>
  <span class="c1"># íŒŒì¼ì„ ì €ì¥í•˜ê±°ë‚˜ git ë“±ìœ¼ë¡œ ê´€ë¦¬ í•  ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ë…¸ì¶œ ìœ„í—˜ì´ ìˆìŒ.</span>
  <span class="c1"># ì„¤ì¹˜ ì´í›„ ë°”ë¡œ ì•”í˜¸ ë³€ê²½ ê¶Œì¥.</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">keycloak1234"</span>

  <span class="c1"># ìœ„ì— 'password'ì— ì•”í˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì§€ ì•Šê³  kubernetesì˜ secretë¥¼ ì‚¬ìš©í•  ê²½ìš° íŒ¨ìŠ¤ì›Œë“œê°€ ì €ì¥ëœ Secretì˜ ì´ë¦„.</span>
  <span class="na">existingSecret</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>

  <span class="c1"># ìœ„ 'existingSecret'ì— ì§€ì •í•œ Secret ì¤‘ ì‚¬ìš©í•  ê°’ì´ ì €ì¥ëœ key ê°’.</span>
  <span class="na">existingSecretKey</span><span class="pi">:</span> <span class="s">password</span>

<span class="nn">...</span>

  <span class="na">ingress</span><span class="pi">:</span>
    <span class="c1"># ingress ì‚¬ìš© ì—¬ë¶€</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>

    <span class="na">annotations</span><span class="pi">:</span> <span class="pi">{}</span>
      <span class="c1"># ssl ì˜¤í”„ë¡œë”© ì‚¬ìš©ì„ ìœ„í•œ ì„¤ì •</span>
      <span class="s">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>

    <span class="na">labels</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="c1"># key: value</span>

    <span class="na">hosts</span><span class="pi">:</span>
      <span class="c1"># ì‚¬ìš©í•  domain</span>
      <span class="pi">-</span> <span class="s">keycloak.mydomain.com</span>

<span class="nn">...</span>

  <span class="na">persistence</span><span class="pi">:</span>
    <span class="c1"># If true, the Postgres chart is deployed</span>
    <span class="c1"># mysqlì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ falseë¡œ ìˆ˜ì •.</span>
    <span class="na">deployPostgres</span><span class="pi">:</span> <span class="no">false</span>

    <span class="c1"># DB ì¢…ë¥˜ ("postgres", "mysql", "mariadb", "h2") ì¤‘ í•˜ë‚˜</span>
    <span class="na">dbVendor</span><span class="pi">:</span> <span class="s">mysql</span>

    <span class="c1"># mysql ì ‘ì† ì •ë³´ê°€ ì €ì¥ëœ kubernetes secret ì´ë¦„.</span>
    <span class="na">existingSecret</span><span class="pi">:</span> <span class="s2">"</span><span class="s">my-db-secret"</span>

    <span class="c1"># ìœ„ 'existingSecret'ì— ì§€ì •í•œ Secret ì¤‘ ì‚¬ìš©í•  ê°’ì´ ì €ì¥ëœ key ê°’.</span>
    <span class="na">existingSecretKey</span><span class="pi">:</span> <span class="s">password</span>

    <span class="c1"># DB ì ‘ì† ì •ë³´</span>
    <span class="na">dbName</span><span class="pi">:</span> <span class="s">db-name</span>
    <span class="na">dbHost</span><span class="pi">:</span> <span class="s">db-host</span>
    <span class="na">dbPort</span><span class="pi">:</span> <span class="m">3306</span>
    <span class="na">dbUser</span><span class="pi">:</span> <span class="s">db-user</span>

<span class="nn">...</span>
</code></pre></div></div>
<ul>
  <li>ì„¤ì¹˜ í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm <span class="nb">install</span> <span class="nt">--name</span> keycloak <span class="nt">-f</span> values.yaml codecentric/keycloak
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">(ê¶Œì¥ì‚¬í•­)</code> ì„¤ì¹˜ í›„ ìœ„ <code class="highlighter-rouge">keycloak.mydomain.com/auth/admin</code>ë¡œ ì ‘ì† í›„ <code class="highlighter-rouge">values.yaml</code>ì˜ username / passwordì— ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ í›„ íŒ¨ìŠ¤ì›Œë“œë¥¼ ë³€ê²½ í•©ë‹ˆë‹¤.
    <ul>
      <li>values.yaml íŒŒì¼ì„ ì €ì¥í•´ë‘ê±°ë‚˜ gitì— ì˜¬ë ¤ ë‘ê±°ë‚˜ í•  ê²½ìš° ë…¸ì¶œ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ìƒì„¸ ì„¤ì •ì€ keycloakì˜ ê³µì‹ ë¬¸ì„œë¥¼ ì°¸ì¡°
    <ul>
      <li>https://www.keycloak.org/documentation.html</li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="radius-ì„œë²„-ì„¤ì¹˜-ë°-keycloak-ì—°ë™-ì„¤ì •">RADIUS ì„œë²„ ì„¤ì¹˜ ë° Keycloak ì—°ë™ ì„¤ì •</h2>

<h3 id="1-eapí™•ì¥-ê°€ëŠ¥-ì¸ì¦-í”„ë¡œí† ì½œ">1. <a href="https://ko.wikipedia.org/wiki/%ED%99%95%EC%9E%A5_%EA%B0%80%EB%8A%A5_%EC%9D%B8%EC%A6%9D_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C">EAP(í™•ì¥ ê°€ëŠ¥ ì¸ì¦ í”„ë¡œí† ì½œ)</a></h3>
<ul>
  <li>Wifi ì ‘ì† ì¸ì¦ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” RADIUS ì„œë²„ê°€ <code class="highlighter-rouge">EAP</code>ë¥¼ ì§€ì›í•´ì•¼ í•©ë‹ˆë‹¤.
    <ul>
      <li>ë‹¨ë§ì—ì„œ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ID/PWë¥¼ RADIUS ì„œë²„ì—ì„œ ë³µí˜¸í™”í•´ì„œ í‰ë¬¸ìœ¼ë¡œ ì¶”ì¶œ í• ìˆ˜ ìˆì–´ì•¼ Keycloakì— ë¡œê·¸ì¸ ìš”ì²­ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      <li>EAP ê·œê²©ì¤‘ <code class="highlighter-rouge">EAP-TTLS</code>ë¥¼ ì‚¬ìš©í•˜ê³  2ì°¨ì¸ì¦ìœ¼ë¡œ <code class="highlighter-rouge">PAP</code>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. PEAP, CHAP ë“±ì˜ ë°©ì‹ì€ hashë¥¼ ì´ìš©í•´ handshakeí•˜ëŠ” ë°©ì‹ì´ë¼ RADIUS ì„œë²„ì—ì„œ ì‚¬ìš©ìê°€ ì…ë ¥í•œ Passwordë¥¼ ì•Œì•„ ë‚¼ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">Wifi ì ‘ì† ì¸ì¦ì´ í•„ìš”ì—†ê³ , SSH ì ‘ì†ì¸ì¦ì„ Keycloakê³¼ ì—°ë™í•˜ê¸° RADIUS ì„œë²„ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° EAP ê´€ë ¨ ì„¤ì •ì€ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤.</code></li>
</ul>

<h3 id="2-êµ¬ì„±">2. êµ¬ì„±</h3>
<ul>
  <li><a href="https://hub.docker.com/r/freeradius/freeradius-server/">Docker Hubì— ê³µê°œë˜ì–´ ìˆëŠ” ì´ë¯¸ì§€</a>ë¥¼ ê¸°ë°˜ìœ¼ë¡œ python ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •í•œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
  <li>FreeRADIUSëŠ” ë‹¤ì–‘í•œ ëª¨ë“ˆì„ ì œê³µí•©ë‹ˆë‹¤. ê·¸ì¤‘ì— <a href="https://wiki.freeradius.org/modules/Rlm_python">Python ëª¨ë“ˆ(rlm_python)</a>ì„ ì´ìš©í•´ keycloakê³¼ ì—°ë™í•©ë‹ˆë‹¤.
    <ul>
      <li><del>ë§ì€ ëª¨ë“ˆì„ ì œê³µí•˜ëŠ”ë° Keycloak ëª¨ë“ˆì€ ì—†ë„¤ìš” ã… _ã… </del></li>
      <li><a href="https://wiki.freeradius.org/modules/Rlm_perl">Perl ëª¨ë“ˆ(rlm_perl)</a>ë„ ìˆìŠµë‹ˆë‹¤.(ì „ Perlì„ ë°°ì›Œ ë³¸ì ì´ ì—†ì–´ì„œâ€¦)</li>
      <li>REST ëª¨ë“ˆ(rlm_rest)ë¡œë„ í•  ìˆ˜ ìˆì„ê±° ê°™ì€ë° keycloak ì—°ë™ì‹œì— API ìš”ì²­ì„ ì—¬ëŸ¬ë²ˆ í•´ì•¼ í•´ì„œ ì´ê±¸ë¡œ í•˜ë©´ ì²˜ë¦¬ê°€ í˜ë“¤ ìˆ˜ ìˆì„ê±° ê°™ì•„ì„œ python ëª¨ë“ˆë¡œ ë°©í–¥ì„ ì¡ì•˜ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>ì²˜ë¦¬ íë¦„ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="mermaid">
graph LR;
  CLIENT[ì‹œì‘: Client] --&gt;|1. RADIUS ìš”ì²­| FREE_RADIUS(FreeRADIUS)
  subgraph Radius-Server
    FREE_RADIUS --&gt;|2| PYTHON_MODULE(Pythonëª¨ë“ˆ)
  end
    PYTHON_MODULE --&gt;|3. ê¶Œí•œí™•ì¸ ìš”ì²­| KEYCLOAK[Keycloak]
    KEYCLOAK --&gt;|4. ê¶Œí•œí™•ì¸ ì‘ë‹µ| PYTHON_MODULE
    PYTHON_MODULE --&gt;|5| FREE_RADIUS
    FREE_RADIUS --&gt;|6. RADIUS ì‘ë‹µ| CLIENT
</div>

<h3 id="3-ì„¤ì¹˜-ì‹œ-ì£¼ì˜ì‚¬í•­-kubernetes-ì‚¬ìš©ì‹œ">3. ì„¤ì¹˜ ì‹œ ì£¼ì˜ì‚¬í•­ (Kubernetes ì‚¬ìš©ì‹œ)</h3>
<ul>
  <li><strong>RadiusëŠ” <code class="highlighter-rouge">UDP</code> Port2ê°œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.(default: 1812, 1813)</strong></li>
  <li><del><code class="highlighter-rouge">UDP</code>ëŠ” AWSì—ì„œ Load Balancerë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</del> <a href="https://aws.amazon.com/ko/blogs/aws/new-udp-load-balancing-for-network-load-balancer/">ì–¼ë§ˆ ì „ë¶€í„° ì§€ì›ì‹œì‘</a></li>
  <li>Kubernetesì— ì„¤ì¹˜ì‹œ ingressì˜ ìœ í˜•ì— ë”°ë¼ UDPë¥¼ ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê·¸ëƒ¥ NodePortë¡œ ë…¸ì¶œ ì‹œí‚¤ê³ , Route53ì—ì„œ Kubernetesì— ì‚¬ìš©ëœ ê° Node(EC2 Instance)ì˜ Public IPë¡œ Round Robinìœ¼ë¡œ ë¶„ì‚° ì‹œì¼œë„ ë©ë‹ˆë‹¤.<a href="https://docs.aws.amazon.com/ko_kr/Route53/latest/DeveloperGuide/routing-policy.html">(ì°¸ê³ )</a></li>
  <li>Kubernetesì—ì„œ NodePortë¥¼ ì‚¬ìš© í•  ê²½ìš° ì‚¬ìš©ê°€ëŠ¥í•œ Port RangeëŠ” <code class="highlighter-rouge">30000-32767</code> ì…ë‹ˆë‹¤.(Radiusì˜ ê¸°ë³¸ Portë²ˆí˜¸ ì‚¬ìš© ë¶ˆê°€)</li>
</ul>

<h3 id="4-freeradius-ì„¤ì •-ë°-docker-image-ìƒì„±">4. FreeRADIUS ì„¤ì • ë° Docker Image ìƒì„±</h3>
<ul>
  <li><a href="https://hub.docker.com/r/freeradius/freeradius-server/">Docker Hubì— ê³µê°œë˜ì–´ ìˆëŠ” ì´ë¯¸ì§€</a>ë¥¼ ê·¸ëŒ€ë¡œ ì´ìš©í•˜ë©´ ì¢‹ì§€ë§Œâ€¦ ê¸°ë³¸ ì´ë¯¸ì§€ëŠ” <code class="highlighter-rouge">python</code>ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li>ì €ëŠ” Python ëª¨ë“ˆì—ì„œ ì•”ë³µí˜¸í™” ê¸°ëŠ¥ë„ ì‚¬ìš©í•  ì˜ˆì •ì´ë¯€ë¡œ <a href="https://pypi.org/project/pycrypto/">pycrypto</a>ë„ í•„ìš”í•©ë‹ˆë‹¤.</li>
  <li>FreeRADIUS ì„¤ì • íŒŒì¼ë“¤ì€ êµ³ì´ Docker Imageì— ë„£ì§€ ì•Šê³  ì‹¤í–‰ì‹œ mount í•´ë„ ìƒê´€ì—†ìŠµë‹ˆë‹¤ë§Œ, ì €ëŠ” Docker Imageì— ì„¤ì •íŒŒì¼ì„ ìˆ˜ì •í•´ì„œ í¬í•¨ ì‹œì¼°ìŠµë‹ˆë‹¤.</li>
  <li>FreeRADIUSì—ì„œ ì‚¬ìš© í•  ì¸ì¦ì„œ íŒŒì¼ë„ ìƒì„±í•´ì„œ ì´ë¯¸ì§€ì— í¬í•¨ì‹œí‚µë‹ˆë‹¤.(ì´ê²ƒë„.. ì‹¤í–‰ì‹œ mount í•´ë„ ë¬´ë°©í•©ë‹ˆë‹¤.)</li>
</ul>

<h3 id="5-freeradiusë¥¼-ê¸°ë°˜ìœ¼ë¡œ-ì»¤ìŠ¤í…€-docker-image-ë§Œë“¤ê¸°">5. FreeRADIUSë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì»¤ìŠ¤í…€ Docker Image ë§Œë“¤ê¸°</h3>

<p><strong>step1. ì„¤ì • ë””ë ‰í† ë¦¬ ê°€ì ¸ì˜¤ê¸°.</strong></p>
<ul>
  <li>ë¨¼ì € <a href="https://hub.docker.com/r/freeradius/freeradius-server/">Docker Hubì— ê³µê°œë˜ì–´ ìˆëŠ” ì´ë¯¸ì§€</a>ë¥¼ ì‹¤í–‰ì‹œí‚¨ í›„ ì„¤ì • ë””ë ‰í† ë¦¬(<code class="highlighter-rouge">/etc/freeradius</code>)ë¥¼ ì¶”ì¶œ í•©ë‹ˆë‹¤.</li>
  <li>ì¶”ì¶œí•œ ì„¤ì • íŒŒì¼ì„ ì ì ˆíˆ ìˆ˜ì •í•˜ê³ , ìˆ˜ì •í•œ íŒŒì¼ì„ ì ìš©í•´ì„œ Docker Imageë¥¼ ìƒˆë¡­ê²Œ ìƒì„±í•  ì˜ˆì •ì…ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--name</span> freeradius-server freeradius/freeradius-server
<span class="nv">$ </span>docker <span class="nb">cp </span>freeradius-server:/etc/freeradius freeradius-config
<span class="nv">$ </span>docker <span class="nb">kill </span>freeradius-server
</code></pre></div></div>

<ul>
  <li>ì„¤ì • ë””ë ‰í† ë¦¬ êµ¬ì¡°(ìˆ˜ì • ë¶ˆí•„ìš”í•œ íŒŒì¼ì€ ìƒëµ..)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
â”œâ”€â”€ certs
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ README
â”‚Â Â  â”œâ”€â”€ ca.cnf
â”‚Â Â  â”œâ”€â”€ client.cnf
â”‚Â Â  â”œâ”€â”€ dh
â”‚Â Â  â”œâ”€â”€ inner-server.cnf
â”‚Â Â  â”œâ”€â”€ passwords.mk
â”‚Â Â  â””â”€â”€ server.cnf
â”œâ”€â”€ clients.conf
â”œâ”€â”€ mods-available
â”‚Â Â  â”œâ”€â”€ ...
â”‚Â Â  â””â”€â”€ python
â”œâ”€â”€ mods-config
â”‚Â Â  â””â”€â”€ python
â”‚Â Â   Â Â  â”œâ”€â”€ example.py
â”‚Â Â   Â Â  â””â”€â”€ radiusd.py
â”œâ”€â”€ mods-enabled
â”‚Â Â  â”œâ”€â”€ ...
â”‚Â Â  â””â”€â”€ utf8
â”œâ”€â”€ radiusd.conf
â”œâ”€â”€ sites-enabled
â”‚Â Â  â”œâ”€â”€ default
â”‚Â Â  â””â”€â”€ inner-tunnel
â”œâ”€â”€ templates.conf
â”œâ”€â”€ trigger.conf
â””â”€â”€ users
</code></pre></div></div>

<p><strong>step 2. ì¸ì¦ì„œ ìƒì„±(Wifi ì¸ì¦)</strong></p>
<ul>
  <li><strong><code class="highlighter-rouge">make</code>ì™€ <code class="highlighter-rouge">openssl</code>ì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</strong>
    <ul>
      <li><a href="https://macnews.tistory.com/4243">make ì„¤ì¹˜</a></li>
      <li><a href="http://egloos.zum.com/popfly/v/6035802">openssl ì„¤ì¹˜</a></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">Wifi ì¸ì¦</code>ì— <code class="highlighter-rouge">EAP-TLS</code>, <code class="highlighter-rouge">EAP-TTLS</code> ë“±ì„ ì‚¬ìš©í•´ì•¼ í•  ê²½ìš° í•„ìš”í•©ë‹ˆë‹¤. ì•„ë‹ ê²½ìš° ë‹¤ìŒ ë‹¨ê²Œë¡œâ€¦</li>
  <li>ì¶”ì¶œí•œ ì„¤ì • ë””ë ‰í† ë¦¬ì¤‘ <a href="https://github.com/redBorder/freeradius/blob/master/raddb/certs/README"><code class="highlighter-rouge">certs/README</code></a>ë¥¼ ì°¸ì¡°í•´ì„œ ì§„í–‰í•©ë‹ˆë‹¤.</li>
  <li>ì¶”ê°€ë¡œ <a href="https://wiki.alpinelinux.org/wiki/FreeRadius_EAP-TLS_configuration"><code class="highlighter-rouge">ì´ê³³</code></a>ë„ ì°¸ì¡°í•˜ì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤.</li>
  <li>ë¨¼ì € ê¸°ì¡´ íŒŒì¼ì„ ì œê±°í•©ë‹ˆë‹¤. (<code class="highlighter-rouge">ì•„ë˜ ì‘ì—…ë“¤ì€ cert ë””ë ‰í† ë¦¬ì—ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.</code>)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-f</span> <span class="k">*</span>.pem <span class="k">*</span>.der <span class="k">*</span>.csr <span class="k">*</span>.crt <span class="k">*</span>.key <span class="k">*</span>.p12 serial<span class="k">*</span> index.txt<span class="k">*</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">ca.cnf</code>, <code class="highlighter-rouge">server.cnf</code>, <code class="highlighter-rouge">client.cnf</code>ë¥¼ ì—´ê³  ìˆ˜ì •í•©ë‹ˆë‹¤.(ì €ëŠ” ì•„ë˜ í•­ëª©ë“¤ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.)
    <ul>
      <li><code class="highlighter-rouge">default_days</code>: ì¸ì¦ì„œ ìœ íš¨ê¸°ê°„</li>
      <li><code class="highlighter-rouge">countryName ~ commonName</code>: ì¸ì¦ì„œì— í¬í•¨ì‹œí‚¬ ì •ë³´</li>
      <li><code class="highlighter-rouge">input_password &amp; output_password</code>: ì¸ì¦ì„œ ì•”í˜¸</li>
    </ul>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>make ca.pem
  <span class="nv">$ </span>make ca.der
  <span class="nv">$ </span>make server.pem
  <span class="nv">$ </span>make server.csr
  <span class="nv">$ </span>make client.pem
  <span class="nv">$ </span>openssl dhparam <span class="nt">-check</span> <span class="nt">-text</span> <span class="nt">-5</span> 4096 <span class="nt">-out</span> dh   <span class="c"># ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŒ... ëª‡ë¶„~ëª‡ì‹­ë¶„</span>
</code></pre></div></div>

<p><strong>step 3. FreeRADIUS ê¸°ë³¸ ì„¤ì •</strong></p>
<ul>
  <li><code class="highlighter-rouge">...</code> ë¶€ë¶„ì€ ê¸°ë³¸ ì„¤ì • ìœ ì§€í•œ ë¶€ë¶„.</li>
  <li><code class="highlighter-rouge">client.conf</code>
    <ul>
      <li><code class="highlighter-rouge">SHARED_SECRET</code> ì‹¤í–‰ì‹œ í™˜ê²½ë³€ìˆ˜ë¡œ ì§€ì •í•©ë‹ˆë‹¤.
        <ul>
          <li>RADIUS í”„ë¡œí† ì½œì—ì„œ attributeë¥¼ ì•”/ë³µí˜¸í™” í• ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client</span> <span class="n">localhost</span> {
  <span class="c"># ...
</span>	<span class="n">secret</span> = $<span class="n">ENV</span>{<span class="n">SHARED_SECRET</span>}
  <span class="c"># ...
</span>}
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">sites-enabled/default</code>
    <ul>
      <li>ê¸°ë³¸ ë¦¬í€˜ìŠ¤íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì„¤ì •ì…ë‹ˆë‹¤.</li>
      <li>eap ì²˜ë¦¬ ì„¤ì • + authorizeì™€ authenticate ë‹¨ê³„ì—ì„œ python ëª¨ë“ˆì„ ì‚¬ìš©í•˜ë„ë¡ ì¶”ê°€í•©ë‹ˆë‹¤.</li>
      <li>authorize ë‹¨ê³„ì—ì„œ ì‹¤í–‰ëœ python scriptì—ì„œ <code class="highlighter-rouge">Auth-Type=KEYCLOAK</code>ë¥¼ ì„¤ì • í•  ì˜ˆì •ì…ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> <span class="n">default</span> {

    <span class="n">authorize</span> {
        <span class="c"># ...
</span>        <span class="n">eap</span> {
            <span class="n">ok</span> = <span class="n">return</span>
            <span class="n">updated</span> = <span class="n">return</span>
        }
        <span class="c"># ...
</span>        <span class="n">python</span>
    }

    <span class="n">authenticate</span> {
        <span class="c"># ...
</span>        <span class="n">Auth</span>-<span class="n">Type</span> <span class="n">KEYCLOAK</span> {
            <span class="n">python</span>
        }
        <span class="c"># ...
</span>        <span class="n">eap</span>
    }
    
<span class="c"># ...
</span>}

</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">sites-enabled/inner-tunnel</code>
    <ul>
      <li><code class="highlighter-rouge">mods-enabled/eap</code>ì—ì„œ EAP-TTLSì˜ <code class="highlighter-rouge">virtual-server</code>ë¡œ inner-tunnelì´ ì„¤ì • ë©ë‹ˆë‹¤.</li>
      <li>ë“¤ì–´ì˜¨ RADIUSìš”ì²­ì´ EAP-TTLSì¼ ê²½ìš° <code class="highlighter-rouge">sites-enabled/default</code>ì—ì„œ eap ê´€ë ¨ ì²˜ë¦¬ê°€ ë˜ê³  inner-tunnelë¡œ ì „ë‹¬ ë©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> <span class="n">inner</span>-<span class="n">tunnel</span> {
    <span class="n">authorize</span> {
        <span class="c"># ...
</span>        <span class="n">pap</span>
        <span class="n">python</span>
    }

    <span class="n">authenticate</span> {
        <span class="n">Auth</span>-<span class="n">Type</span> <span class="n">KEYCLOAK</span> {
            <span class="n">python</span>
        }
        <span class="c"># ...
</span>        <span class="n">eap</span>
    }
}
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">mods-enabled/eap</code>
    <ul>
      <li><code class="highlighter-rouge">default_eap_type</code>ì€ <code class="highlighter-rouge">ttls(EAP-TTLS)</code>ë¡œ ì§€ì • í•©ë‹ˆë‹¤.</li>
      <li>tls, ttls ê´€ë ¨ ì„¤ì •ì„ ë¹¼ê³  ë‹¤ë¥¸ EAP Type ë“¤ì€ ì£¼ì„ì²˜ë¦¬ í•©ë‹ˆë‹¤.</li>
      <li><code class="highlighter-rouge">private_key_password</code>ëŠ” ì¸ì¦ì„œ ìƒì„±ì‹œì— ë§Œë“¤ë•Œ ì“´ ì•”í˜¸ ì…ë ¥ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">eap</span> {
  <span class="c"># ...
</span>	<span class="n">default_eap_type</span> = <span class="n">ttls</span>
	<span class="n">ignore_unknown_eap_types</span> = <span class="n">yes</span>

	<span class="c">#md5 {
</span>	<span class="c">#}
</span>
	<span class="c">#pwd {
</span>	<span class="c">#}
</span>
	<span class="c">#leap {
</span>	<span class="c">#}
</span>
	<span class="c">#gtc {
</span>	<span class="c">#}
</span>
	<span class="n">tls</span>-<span class="n">config</span> <span class="n">tls</span>-<span class="n">common</span> {
		<span class="n">private_key_password</span> = &lt;<span class="n">private_key_password</span>&gt;
      <span class="c"># ...
</span>	}


	<span class="n">tls</span> {
    <span class="c"># ...
</span>		<span class="n">tls</span> = <span class="n">tls</span>-<span class="n">common</span>
    <span class="c"># ...
</span>	}

	<span class="n">ttls</span> {
    <span class="c"># ...
</span>		<span class="n">tls</span> = <span class="n">tls</span>-<span class="n">common</span>
    <span class="c"># ...
</span>		<span class="n">virtual_server</span> = <span class="s2">"inner-tunnel"</span>
    <span class="c"># ...
</span>	}

	<span class="c">#peap {
</span>	<span class="c">#}
</span>
	<span class="c">#mschapv2 {
</span>	<span class="c">#}
</span>
	<span class="c">#fast {
</span>	<span class="c">#}
</span>}
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">mods-enabled/python</code>
    <ul>
      <li>python ëª¨ë“ˆ ì‹¤í–‰ ì„¤ì • ì…ë‹ˆë‹¤.</li>
      <li><code class="highlighter-rouge">python_path</code>ì— <code class="highlighter-rouge">:</code>ë¡œ êµ¬ë¶„í•´ì„œ ì°¸ì¡° í•  ëª¨ë“ˆì˜ pathë¥¼ ì§€ì •</li>
      <li>command lineì—ì„œ pythonì„ ì‹¤í–‰í•˜ëŠ” ê²½ìš° ê¸°ë³¸ python module ë° ì¶”ê°€ ì„¤ì¹˜ëœ module ë“¤ì˜ pathê°€ ê¸°ë³¸ ì„¤ì •ëœ ì±„ë¡œ ì‹¤í–‰ë˜ì§€ë§Œ FreeRADIUSì—ì„œ pythonì„ ì‹¤í–‰í•´ ì¤„ë•ŒëŠ” ê·¸ë ‡ì§€ ì•Šìœ¼ë¯€ë¡œ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš© í• (import í•˜ëŠ”..) ëª¨ë“ˆ ë“¤ì´ ìˆëŠ” pathë¥¼ ì¶”ê°€í•´ ì£¼ì–´ì•¼í•¨.</li>
      <li>Dockerfileì—ì„œ ì´ë¯¸ì§€ ìƒì„±ì‹œ ì¶”ê°€í•˜ëŠ” ëª¨ë“ˆë“¤ì˜ docker image ë‚´ ê²½ë¡œë¥¼ í™•ì¸í•´ì„œ ì¶”ê°€í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.</li>
      <li>ì•„ë˜ëŠ” <code class="highlighter-rouge">pycrypto</code>ê°€ ì„¤ì¹˜ëœ ê²½ë¡œë¥¼ ì¶”ê°€í•œ ì„¤ì •ì…ë‹ˆë‹¤. (ì•„ë˜ Docker file ì°¸ì¡°)</li>
    </ul>
  </li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> {
	<span class="n">python_path</span>=<span class="s2">"/usr/lib/python2.7/:/usr/local/lib/python2.7/dist-packages:${modconfdir}/python/:/usr/lib/python2.7/lib-dynload/"</span>
	<span class="n">module</span> = <span class="n">keycloak</span>
	<span class="n">pass_all_vps</span> = <span class="n">no</span>
	<span class="n">pass_all_vps_dict</span> = <span class="n">yes</span>

  <span class="c"># ...
</span>
	<span class="n">mod_authorize</span> = ${.<span class="n">module</span>}
	<span class="n">func_authorize</span> = <span class="n">authorize</span>

	<span class="n">mod_authenticate</span> = ${.<span class="n">module</span>}
	<span class="n">func_authenticate</span> = <span class="n">authenticate</span>

  <span class="c"># ... 
</span>}
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">mods-config/python/keycloak.py</code>
    <ul>
      <li>ì›ë˜ í•´ë‹¹ ë””ë ‰í† ë¦¬ì—ëŠ” <code class="highlighter-rouge">radiusd.py</code> / <code class="highlighter-rouge">example.py</code> ë‘ê°œ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤.</li>
      <li><code class="highlighter-rouge">radiusd.py</code>ëŠ” ë°˜í™˜ê°’ ìƒìˆ˜ ë° ë¡œê·¸ ì¶œë ¥ì„ ìœ„í•œ í•¨ìˆ˜ê°€ ì„ ì–¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.(<strong>ìë™ìƒì„±ëœ íŒŒì¼ë¡œ ìˆ˜ì •í•´ë„ ì˜ë¯¸ê°€ ì—†ìŠµë‹ˆë‹¤.</strong>)</li>
      <li><code class="highlighter-rouge">example.py</code> -&gt; <code class="highlighter-rouge">keycloak.py</code>ë¡œ ë³€ê²½(ìœ„ mods-enabled/python íŒŒì¼ì—ì„œë„ module ëª…ì„ ë¯¸ë¦¬ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.)</li>
      <li>ê° ë‹¨ê³„ë³„ í•¨ìˆ˜ì— ë„˜ì–´ì˜¤ëŠ” <code class="highlighter-rouge">p</code>ëŠ” <code class="highlighter-rouge">tuple</code>ì´ë©°, ì¼ë°˜ì ìœ¼ë¡œ <code class="highlighter-rouge">(('User-Name', 'dorma'), ('User-Password', 'password'), ('NAS-Identifier', 'client-identifier'), ...)</code>ìœ¼ë¡œ ì „ë‹¬ ë©ë‹ˆë‹¤.</li>
      <li><strong>ì¸ì¦ ë°©ì‹ì´ <code class="highlighter-rouge">PAP</code>ê°€ ì•„ë‹ ê²½ìš° <code class="highlighter-rouge">User-Password</code>ëŠ” ì „ë‹¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</strong></li>
      <li><code class="highlighter-rouge">authorize</code>ë‹¨ê³„ì—ì„œëŠ” username / passwordê°€ ìˆëŠ” ê²½ìš° <code class="highlighter-rouge">Auth-Type=KEYCLOAK</code>ìœ¼ë¡œ ì„¤ì •í•˜ë©°, <code class="highlighter-rouge">authenticate</code>ë‹¨ê³„ì—ì„œ ì‹¤ì œ ì¸ì¦ì„ ì²˜ë¦¬ í•©ë‹ˆë‹¤.
        <ul>
          <li>sites-enabled ì„¤ì •ì˜ authenticateì—ì„œ Auth-Type ë¶„ê¸°ì²˜ë¦¬ê°€ ë˜ì–´ìˆì–´ì„œ username / passwordê°€ ì—†ìœ¼ë©´ authenticate í•¨ìˆ˜ëŠ” í˜¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì‹¤ì œ ì¸ì¦ì²˜ë¦¬ ë¡œì§ì€ <a href="https://www.keycloak.org/docs-api/6.0/rest-api/index.html">keycloak API</a> ì°¸ê³  í•˜ì…”ì„œ êµ¬í˜„í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
        <ul>
          <li>ê¼­ keycloakê³¼ ì—°ë™ ì•ˆí•˜ê³  pythonìœ¼ë¡œ ì–´ë–¤ ì²˜ë¦¬ë“  í•˜ê³  ê²°ê³¼ë§Œ ë°˜í™˜í•˜ë©´ ë˜ë‹ˆ ì›í•˜ëŠ” ì„œë²„ í˜¹ì€ DB ë² ì´ìŠ¤ë¡œ ì¸ì¦ì²˜ë¦¬ë¥¼ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#! /usr/bin/env python2
</span>
<span class="kn">import</span> <span class="nn">radiusd</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">authorize</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
  <span class="n">username</span> <span class="o">=</span> <span class="n">getUserName</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
  <span class="n">password</span> <span class="o">=</span> <span class="n">getUserPassword</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">password</span><span class="p">:</span>
    <span class="c1"># tupleë¡œ ë°˜í™˜ì‹œ `ì¸ì¦ê²°ê³¼, response, FreeRADIUS ë‚´ë¶€ ì²˜ë¦¬ ë³€ìˆ˜` ìˆœìœ¼ë¡œ ë°˜í™˜ ê°€ëŠ¥
</span>    <span class="k">return</span> <span class="p">(</span>
      <span class="n">radiusd</span><span class="o">.</span><span class="n">RLM_MODULE_UPDATED</span><span class="p">,</span>
      <span class="p">(),</span>
      <span class="p">((</span><span class="s">'Auth-Type'</span><span class="p">,</span> <span class="s">"KEYCLOAK"</span><span class="p">),)</span>
    <span class="p">)</span>
  <span class="k">else</span> <span class="p">:</span>
    <span class="c1"># ì²˜ë¦¬ ê²°ê³¼ ë°˜í™˜
</span>    <span class="k">return</span> <span class="n">radius</span><span class="o">.</span><span class="n">RLM_MODULE_REJECT</span>

<span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
  <span class="n">username</span> <span class="o">=</span> <span class="n">getUserName</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
  <span class="n">password</span> <span class="o">=</span> <span class="n">getUserPassword</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
  <span class="n">nasId</span> <span class="o">=</span> <span class="n">getNasIdentifier</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
  
  <span class="c1"># ...&lt;ì¸ì¦ ì²˜ë¦¬&gt;...
</span>
  <span class="k">if</span> <span class="n">authResult</span> <span class="p">:</span>
    <span class="k">return</span> <span class="n">radiusd</span><span class="o">.</span><span class="n">RLM_MODULE_OK</span>
  <span class="k">else</span> <span class="p">:</span>
    <span class="k">return</span> <span class="n">radiusd</span><span class="o">.</span><span class="n">RLM_MODULE_REJECT</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">getNasIdentifier</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">:</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">p</span> <span class="p">:</span>
    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">"NAS-Identifier"</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
      <span class="k">return</span> <span class="n">val</span>
  <span class="k">return</span> <span class="s">""</span>

<span class="k">def</span> <span class="nf">getUserName</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">:</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">p</span> <span class="p">:</span>
    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">"User-Name"</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
      <span class="k">return</span> <span class="n">val</span>
  <span class="k">return</span> <span class="s">""</span>

<span class="k">def</span> <span class="nf">getUserPassword</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">:</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">p</span> <span class="p">:</span>
    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">"User-Password"</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
      <span class="k">return</span> <span class="n">val</span>
  <span class="k">return</span> <span class="s">""</span>
</code></pre></div></div>

<p><strong>step 4. Docker Image ìƒì„±</strong></p>
<ul>
  <li><a href="https://hub.docker.com/r/freeradius/freeradius-server/">Docker Hubì— ê³µê°œë˜ì–´ ìˆëŠ” ì´ë¯¸ì§€</a>ë¥¼ ë² ì´ìŠ¤
    <ol>
      <li>python ì„¤ì¹˜</li>
      <li>python ì¶”ê°€ ëª¨ë“ˆ ì„¤ì¹˜(ì•„ë˜ ì˜ˆì‹œëŠ” <a href="https://pypi.org/project/pycrypto/">pycrypto</a>, pycryptoëŠ” ì„¤ì¹˜ì‹œ ë¹Œë“œê°€ í•„ìš”í•´ì„œ build-essentialë„ ì„¤ì¹˜í–ˆë‹¤ê°€ ì„¤ì¹˜ í›„ ì œê±°)</li>
      <li>ìœ„ì—ì„œ ìˆ˜ì •í•œ ì„¤ì •íŒŒì¼ë“¤ì„ ì„¤ì • ë””ë ‰í† ë¦¬(<code class="highlighter-rouge">/etc/raddb</code>) ì•„ë˜ì— ë®ì–´ì“°ê¸°</li>
    </ol>
  </li>
</ul>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> freeradius/freeradius-server:3.0.17</span>

<span class="k">RUN </span><span class="se">\
</span>  apt-get update <span class="nt">--force-yes</span> <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>  apt-get <span class="nb">install</span> <span class="nt">--force-yes</span> <span class="nt">-y</span> python python-dev curl build-essential

<span class="k">RUN </span>curl <span class="nt">-o</span> pycrypto-2.6.1.tar.gz https://ftp.dlitz.net/pub/dlitz/crypto/pycrypto/pycrypto-2.6.1.tar.gz
<span class="k">RUN </span><span class="nb">tar</span> <span class="nt">-xzf</span> pycrypto-2.6.1.tar.gz
<span class="k">RUN </span><span class="nb">rm</span> <span class="nt">-rf</span> pycrypto-2.6.1.tar.gz
<span class="k">WORKDIR</span><span class="s"> /pycrypto-2.6.1</span>
<span class="k">RUN </span>python setup.py <span class="nb">install</span>
<span class="k">WORKDIR</span><span class="s"> /</span>
<span class="k">RUN </span><span class="nb">rm</span> <span class="nt">-rf</span> pycrypto-2.6.1

<span class="k">RUN </span>apt-get remove <span class="nt">--force-yes</span> <span class="nt">-y</span> <span class="nt">--auto-remove</span> build-essential
<span class="k">RUN </span>apt-get purge <span class="nt">--force-yes</span> <span class="nt">-y</span> <span class="nt">--auto-remove</span> build-essential

<span class="k">COPY</span><span class="s"> ./freeradius-config/radiusd.conf /etc/raddb/radiusd.conf</span>
<span class="k">COPY</span><span class="s"> ./freeradius-config/clients.conf /etc/raddb/clients.conf</span>
<span class="k">COPY</span><span class="s"> ./freeradius-config/sites-enabled/default /etc/raddb/sites-enabled/default</span>
<span class="k">COPY</span><span class="s"> ./freeradius-config/sites-enabled/inner-tunnel /etc/raddb/sites-enabled/inner-tunnel</span>
<span class="k">COPY</span><span class="s"> ./freeradius-config/mods-enabled/eap /etc/raddb/mods-enabled/eap</span>
<span class="k">COPY</span><span class="s"> ./freeradius-config/mods-enabled/python /etc/raddb/mods-enabled/python</span>
<span class="k">COPY</span><span class="s"> ./freeradius-config/certs /etc/raddb/certs</span>
<span class="k">COPY</span><span class="s"> ./freeradius-config/mods-config/python /etc/raddb/mods-config/python</span>

<span class="k">WORKDIR</span><span class="s"> /etc/raddb/mods-config/python</span>
<span class="k">RUN </span><span class="nb">rm</span> <span class="nt">-rf</span> <span class="k">*</span>.pyc

<span class="k">WORKDIR</span><span class="s"> /</span>
</code></pre></div></div>

<ul>
  <li>docker build &amp; push</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker build <span class="nt">-t</span> socar/radius-server:0.9.1 <span class="nb">.</span>
<span class="nv">$ </span>docker push <span class="nt">-t</span> socar/radius-server:0.9.1
</code></pre></div></div>

<h3 id="6-docker-composeë¡œ-ë°°í¬í•˜ê¸°">6. Docker-composeë¡œ ë°°í¬í•˜ê¸°</h3>
<ul>
  <li><code class="highlighter-rouge">docker-compose.yml</code> ì˜ˆì‹œ</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">radius-server</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">free-radius-server</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">socarr/radius-server:0.9.1</span>
    <span class="na">env_file</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./config.env</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">31812:1812/udp</span>
      <span class="pi">-</span> <span class="s">31813:1813/udp</span>
    <span class="na">volumes</span><span class="pi">:</span> <span class="pi">[]</span>
      <span class="c1">#- ./logs:/var/log/freeradius</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">config.env</code> ì˜ˆì‹œ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SHARED_SECRET</span><span class="o">=</span>&lt;my-shared-secret&gt;
</code></pre></div></div>

<ul>
  <li>ë°°í¬ (docker-compose.yml, config.envê°€ ìˆëŠ” ê²½ë¡œì—ì„œ ì‹¤í–‰)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<hr />

<h2 id="keycloak-ìœ ì €ë¡œ-ssh-ë¡œê·¸ì¸-í•˜ê¸°">Keycloak ìœ ì €ë¡œ ssh ë¡œê·¸ì¸ í•˜ê¸°</h2>
<ul>
  <li><code class="highlighter-rouge">Ubuntu Linux</code> ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤.</li>
</ul>

<h3 id="1-êµ¬ì„±ë„">1. êµ¬ì„±ë„</h3>
<div class="mermaid">
graph TD;
  subgraph Linux
    CLIENT[ì‹œì‘: ssh/sudo] --&gt;|1. PAM ëª¨ë“ˆ í˜¸ì¶œ| PAM(pam_radius_auth.so)
    PAM --&gt;|6. ì¸ì¦ ì™„ë£Œ| CLIENT
  end
  
  subgraph Radius-Server
    PAM --&gt; |2. RADIUS ìš”ì²­| RADIUS_SERVER
  end

  subgraph Keycloak
    RADIUS_SERVER --&gt;|3. ê¶Œí•œí™•ì¸ ìš”ì²­| KEYCLOAK[Keycloak]
    KEYCLOAK --&gt;|4. ê¶Œí•œí™•ì¸ ì‘ë‹µ| RADIUS_SERVER
  end
  
  RADIUS_SERVER --&gt;|5. RADIUS ì‘ë‹µ| PAM
</div>

<h3 id="2-pam_radius_authso-ë¹Œë“œ-í•˜ê¸°">2. <a href="https://github.com/FreeRADIUS/pam_radius"><code class="highlighter-rouge">pam_radius_auth.so</code></a> ë¹Œë“œ í•˜ê¸°</h3>
<ul>
  <li>ì €ëŠ” Macì„ ì‚¬ìš©í•˜ë¯€ë¡œ ubuntu docker ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì„œ ë¹Œë“œí•©ë‹ˆë‹¤.</li>
  <li>ë‹¤ìš´ë¡œë“œ í˜¹ì€ clone ë°›ì€ ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ì—ì„œ ì§„í–‰ í•©ë‹ˆë‹¤.</li>
  <li>ë¹Œë“œìš© ì´ë¯¸ì§€ ìƒì„±ì„ ìœ„í•œ Dockerfile</li>
</ul>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ubuntu</span>

<span class="k">RUN </span><span class="se">\
</span>  apt-get update <span class="nt">--force-yes</span> <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>  apt-get <span class="nb">install</span> <span class="nt">--yes</span> build-essential libpam0g-dev make
</code></pre></div></div>

<ul>
  <li>docker build</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker build <span class="nt">-t</span> pam_builder <span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>docker run</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/pam_radius <span class="nt">-w</span> /pam_radius pam_builder ./configure
<span class="nv">$ </span>docker run <span class="nt">-v</span> <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>:/pam_radius <span class="nt">-w</span> /pam_radius pam_builder make
</code></pre></div></div>

<ul>
  <li>ë¹Œë“œê°€ ì™„ë£Œë˜ë©´ <code class="highlighter-rouge">pam_radius_auth.so</code>íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤.</li>
</ul>

<h3 id="3-pam_radius_authso-ì—…ë¡œë“œ-í•˜ê¸°">3. <code class="highlighter-rouge">pam_radius_auth.so</code> ì—…ë¡œë“œ í•˜ê¸°</h3>
<ul>
  <li>ì €ëŠ” ubuntu ì„œë²„ì— ì—…ë¡œë“œ í›„ <code class="highlighter-rouge">/opt/pam/pam_radius_auth.so</code> ê²½ë¡œì— ìœ„ì¹˜ ì‹œì¼°ìŠµë‹ˆë‹¤.</li>
</ul>

<h3 id="4-pam_radius_authso-ì„¤ì •í•˜ê¸°">4. <code class="highlighter-rouge">pam_radius_auth.so</code> ì„¤ì •í•˜ê¸°</h3>
<ol>
  <li><code class="highlighter-rouge">/etc/raddb/server</code> íŒŒì¼ ìƒì„±
    - ì†ŒìŠ¤ìƒì˜ <a href="https://github.com/FreeRADIUS/pam_radius/blob/master/pam_radius_auth.conf"><code class="highlighter-rouge">pam_radius_auth.conf</code></a> íŒŒì¼ ì°¸ì¡°.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="c"># server[:port]             shared_secret      timeout (s)  source_ip            vrf</span>
&lt;radius-server&gt;:&lt;auth-port&gt;	     &lt;shared_secret&gt;		&lt;<span class="nb">timeout</span><span class="o">&gt;</span>
...
</code></pre></div></div>

<h3 id="5-sshd-ì„¤ì •">5. <code class="highlighter-rouge">sshd</code> ì„¤ì •</h3>
<ul>
  <li><a href="https://github.com/FreeRADIUS/pam_radius/blob/master/USAGE">pam_radius_auth.so ì„¤ì • ì˜µì…˜</a> ì°¸ê³ </li>
  <li><code class="highlighter-rouge">/etc/pam.d/sshd</code> ì„¤ì •.
    <ul>
      <li><code class="highlighter-rouge">@include common-auth</code>ì„ ë‚¨ê²¨ë‘ê³ . pam_radius_auth.soì˜ pam optionì„ <code class="highlighter-rouge">[default=ignore]</code>ë¡œ ì„¤ì • í•˜ë©´ pam_radius_auth.soë¥¼ ì´ìš©í•œ ì¸ì¦ì´ ì‹¤íŒ¨ í•  ê²½ìš° ê¸°ë³¸ linux ì‚¬ìš©ì ì¸ì¦ ë°©ì‹ìœ¼ë¡œ ì¸ì¦ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
      <li><code class="highlighter-rouge">client_id</code>ëŠ” RADIUSì„œë²„ë¡œ ì „ë‹¬ ë ë•Œ <code class="highlighter-rouge">NAS-Identifier</code>ë¡œ ì „ë‹¬ë˜ë‹ˆ ì—¬ëŸ¬ëŒ€ì˜ ì„œë²„ì— ì„¤ì • í•  ê²½ìš° ì„œë²„ ë° ssh, sudoë¥¼ êµ¬ë¶„ í•  ìˆ˜ ìˆëŠ” ê°’ì„ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.(<a href="/posts/keycloak-radius">RADIUS ì„œë²„ ì„¤ì¹˜ ë° Keycloak ì—°ë™ ì„¤ì •</a>ì˜ python ëª¨ë“ˆì—ì„œ <code class="highlighter-rouge">NAS-Identifier</code> ê°’ìœ¼ë¡œ ë¶„ê¸°ì²˜ë¦¬ ê°€ëŠ¥.)</li>
    </ul>
  </li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...
# Standard Un*x authentication.
</span><span class="n">auth</span> [<span class="n">success</span>=<span class="n">done</span> <span class="n">default</span>=<span class="n">ignore</span>]	/<span class="n">opt</span>/<span class="n">pam</span>/<span class="n">pam_radius_auth</span>.<span class="n">so</span> <span class="n">client_id</span>=<span class="n">ssh</span>-<span class="m">10</span>.<span class="m">100</span>.<span class="m">13</span>.<span class="m">179</span> <span class="n">force_prompt</span> <span class="n">prompt_attribute</span>
@<span class="n">include</span> <span class="n">common</span>-<span class="n">auth</span>
<span class="c"># ...
</span></code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">/etc/ssh/sshd_config</code> ê¸°ë³¸ ì„¤ì •.
    <ul>
      <li><code class="highlighter-rouge">PasswordAuthentication no</code> ì„¤ì •ì‹œ sshdì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì¶œë ¥í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¬»ëŠ” promptë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
      <li><code class="highlighter-rouge">ChallengeResponseAuthentication yes</code> ì„¤ì •ì‹œ PAM ëª¨ë“ˆì—ì„œ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œ í•  prompt ë©”ì„¸ì§€ë¥¼ í•¸ë“¤ë§ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...
</span><span class="n">PasswordAuthentication</span> <span class="n">no</span>
<span class="n">ChallengeResponseAuthentication</span> <span class="n">yes</span>
<span class="c"># ...
</span></code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">(ì„ íƒì‚¬í•­)</code> <code class="highlighter-rouge">/etc/ssh/sshd_config</code> ì¶”ê°€ì„¤ì •
    <ul>
      <li>íŠ¹ì • ì‚¬ìš©ì(keycloak / radius-server ì ‘ì† ë¶ˆê°€ì‹œ ì‚¬ìš©)ë¥¼ ì œì™¸í•˜ê³  RSA keyë¥¼ ì´ìš©í•œ ë¡œê·¸ì¸ì„ ë§‰ê³  ì‹¶ì€ ê²½ìš°.</li>
      <li>ì•„ë˜ ì˜ˆì‹œì™€ ê°™ì´ <code class="highlighter-rouge">AuthorizedKeysFile</code>ë¥¼ ì ˆëŒ€ê²½ë¡œë¡œ ì§€ì •.</li>
    </ul>
  </li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">AuthorizedKeysFile</span>	/<span class="n">home</span>/<span class="n">dorma</span>/.<span class="n">ssh</span>/<span class="n">authorized_keys</span>
</code></pre></div></div>

<h3 id="6-sudo-ì„¤ì •">6. <code class="highlighter-rouge">sudo</code> ì„¤ì •</h3>
<ul>
  <li><code class="highlighter-rouge">/etc/pam.d/sudo</code> ì„¤ì •.
    <ul>
      <li><code class="highlighter-rouge">@include common-auth</code>ì„ ë‚¨ê²¨ë‘ê³ . pam_radius_auth.soì˜ pam optionì„ <code class="highlighter-rouge">[default=ignore]</code>ë¡œ ì„¤ì • í•˜ë©´ pam_radius_auth.soë¥¼ ì´ìš©í•œ ì¸ì¦ì´ ì‹¤íŒ¨ í•  ê²½ìš° ê¸°ë³¸ linux ì‚¬ìš©ì ì¸ì¦ ë°©ì‹ìœ¼ë¡œ ì¸ì¦ ê°€ëŠ¥.</li>
      <li><code class="highlighter-rouge">client_id</code>ëŠ” RADIUSì„œë²„ë¡œ ì „ë‹¬ ë ë•Œ <code class="highlighter-rouge">NAS-Identifier</code>ë¡œ ì „ë‹¬ë˜ë‹ˆ ì—¬ëŸ¬ëŒ€ì˜ ì„œë²„ì— ì„¤ì • í•  ê²½ìš° ì„œë²„ ë° ssh, sudoë¥¼ êµ¬ë¶„ í•  ìˆ˜ ìˆëŠ” ê°’ì„ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.(<a href="/posts/keycloak-radius">RADIUS ì„œë²„ ì„¤ì¹˜ ë° Keycloak ì—°ë™ ì„¤ì •</a>ì˜ python ëª¨ë“ˆì—ì„œ <code class="highlighter-rouge">NAS-Identifier</code> ê°’ìœ¼ë¡œ ë¶„ê¸°ì²˜ë¦¬ ê°€ëŠ¥.)</li>
    </ul>
  </li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ...
</span><span class="n">auth</span> [<span class="n">success</span>=<span class="n">done</span> <span class="n">default</span>=<span class="n">ignore</span>] /<span class="n">opt</span>/<span class="n">pam</span>/<span class="n">pam_radius_auth</span>.<span class="n">so</span> <span class="n">client_id</span>=<span class="n">sudo</span>-<span class="m">10</span>.<span class="m">100</span>.<span class="m">13</span>.<span class="m">179</span> <span class="n">force_prompt</span> <span class="n">prompt_attribute</span>
@<span class="n">include</span> <span class="n">common</span>-<span class="n">auth</span>
<span class="c"># ...
</span></code></pre></div></div>

<hr />

<h2 id="cisco-ë¬´ì„ -ê³µìœ ê¸°-ì„¤ì •">Cisco ë¬´ì„  ê³µìœ ê¸° ì„¤ì •</h2>
<ul>
  <li>`ë¬´ì„  ê³µìœ ê¸°ì—ì„œ RADIUS ì„œë²„ì™€ ì—°ë™ ì„¤ì •ì„ í•˜ê³  SSIDë¥¼ ë„ì›ë‹ˆë‹¤.
    <ul>
      <li><del>ìì„¸í•œ ì„¤ì •ì€ ë„¤íŠ¸ì›Œí¬ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”?!</del></li>
      <li>ì°¸ê³ : <a href="https://www.cisco.com/c/en/us/support/docs/wireless-mobility/wireless-lan-wlan/211263-Configure-802-1x-PEAP-with-FreeRadius.html">Cisco ë¼ìš°í„°ì—ì„œ FreeRADIUS ì—°ë™ ì„¤ì • í•˜ê¸°</a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="ì •ë¦¬--ì¶”ê°€ë¡œ-ê°€ëŠ¥í•œ-ê²ƒ">ì •ë¦¬ + ì¶”ê°€ë¡œ ê°€ëŠ¥í•œ ê²ƒ</h2>
<ul>
  <li><code class="highlighter-rouge">Keycloak + FreeRADIUS + pam_radius_auth.so + keycloak APIë¡œ ì¸ì¦ì²˜ë¦¬ python ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±</code>ìœ¼ë¡œ web, wifi, ssh ì¸ì¦ì„ <code class="highlighter-rouge">1ê°œì˜ IDë¡œ ê°ì¢… ì‚¬ë‚´ ì„œë¹„ìŠ¤ ì¸ì¦</code>ì„ êµ¬ì¶• ê³¼ì •ì„ ì •ë¦¬í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.
    <ul>
      <li>ì‚¬ì‹¤ <code class="highlighter-rouge">ì„¤ì¹˜ ë° ì„¤ì •</code>ì´ ê³¼ì •ì˜ ëŒ€ë¶€ë¶„ì´ê³  ê°œë°œ(ì½”ë“œì‘ì„±)ì€ <code class="highlighter-rouge">python ìŠ¤í¬ë¦½íŠ¸ 100~200ì¤„ ì •ë„</code>í•˜ì˜€ìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>wifië‚˜ ssh ì¸ì¦ ê°™ì€ ê²½ìš° íŒ¨ìŠ¤ì›Œë“œë¥¼ ê³µìœ í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ë³´ì•ˆì˜ êµ¬ë©ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³´ì™„ì±…ìœ¼ë¡œ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ”ë° wifiì˜ ê²½ìš° í¬ê²Œ ë¬¸ì œê°€ ë˜ì§€ ì•Šì§€ë§Œ ssh ì¸ì¦ ê°™ì€ ê²½ìš°ëŠ” ì„œë²„ ëŒ€ìˆ˜ê°€ ëŠ˜ì–´ë‚˜ë©´ ì£¼ê¸°ì ì¸ ë³€ê²½ì´ ì‰½ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
  <li><strong>ìœ„ ì„¤ì •ì˜ ê²½ìš° ssh ì ‘ì†ì „ì— ì„œë²„ë³„ë¡œ ê³„ì •ì€ ë¯¸ë¦¬ ìƒì„±ì´ ë˜ì–´ìˆì–´ì•¼ ì ‘ì†ì´ ê°€ëŠ¥</strong> í•˜ì§€ë§Œ ì´í›„ íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½ ë“±ì€ ê°œë³„ ì‚¬ìš©ìë³„ë¡œ ê´€ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>ìœ„ì—ì„œëŠ” ìì„¸íˆ ì„¤ëª…í•˜ì§€ëŠ” ì•Šì•˜ì§€ë§Œ keycloakì˜ ê¶Œí•œê´€ë¦¬(authorization)ë¥¼ ì˜ ì„¤ì •í•˜ê³  python ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¸ì¦ + ê¶Œí•œí™•ì¸ì„ ì²˜ë¦¬í•˜ê²Œ ë˜ë©´ <strong>ê°œë³„ ì‚¬ìš©ìë³„ë¡œ íŠ¹ì • ì„œë²„ì— ëŒ€í•œ ì ‘ê·¼ì„ í—ˆìš©í• ì§€ì— ëŒ€í•œ ê´€ë¦¬ë„ ê°€ëŠ¥</strong>í•´ì§‘ë‹ˆë‹¤.</li>
  <li>ê·¸ ë°–ì—ë„ <a href="https://github.com/keycloak/keycloak-gatekeeper">keycloak-gatekeeper</a>ë¥¼ ì˜ í™œìš©í•˜ë©´ APIì„œë²„ì—ì„œëŠ” ì¸ì¦/ê¶Œí•œ ê´€ë ¨ ì½”ë“œë¥¼ í•œì¤„ë„ ì‘ì„±í•˜ì§€ ì•Šê³  ê¸°ëŠ¥ë§Œ ì‘ì„±í•œ í›„ì— gatekeeperë¥¼ í™œìš©í•´ url / http method ë³„ë¡œ ì ‘ê·¼ ê¶Œí•œ ì²˜ë¦¬ë„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

        </div>
        
        <hr>
        <div class="clearfix">
          
          
          <a class="btn btn-primary float-right" href="/security/2019/09/02/aviatrix-fqdn.html" data-toggle="tooltip" data-placement="top" title="AWS VPCì—ì„œ FQDN Outbound Control">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          
        </div>
        <div>
          <p class="recuit">ì˜ì¹´ëŠ” ì–¸ì œë‚˜ ì˜ì¹´ ì„œë¹„ìŠ¤ë¥¼ í•¨ê»˜ ë§Œë“¤ë©° ê¸°ìˆ ì ì¸ ë¬¸ì œë¥¼ í•¨ê»˜ í’€ì–´ë‚˜ê°ˆ ëŠ¥ë ¥ìˆëŠ” ê°œë°œì/ë””ìì´ë„ˆ/ê¸°íšì/ë°ì´í„° ì‚¬ì´ì–¸í‹°ìŠ¤íŠ¸ ë“±ì„ ëª¨ì‹œê³  ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ <a href="https://bit.ly/SOCAR-RECRUIT">ì˜ì¹´ ì±„ìš©ê³µê³  í˜ì´ì§€</a>ë¥¼ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤ :)</p>
        </div>
      </div>
    </div>
    <!-- utterance comments -->
    <script src="https://utteranc.es/client.js"
        repo="socar-inc/techblog-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
    </script>
  </div>

<script>
  // ref https://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '#toc',
    contentSelector: '.post-content',
    headingSelector: 'h1, h2, h3',
    hasInnerContainers: true,
    collapseDepth: 6,
    linkClass: 'toc-link'
  });


  $(window).on('scroll', function() {
      let scrollTop = $(window).scrollTop()
      let scrollBottom =  scrollTop + $(window).height()
      let contentOffsetTop = $(".post-content").offset().top
      let contentOffsetBottom = contentOffsetTop + $(".post-content").height()
      let elementHeight = $(".post-content").height(); 

      if ((scrollTop < contentOffsetTop) || (scrollBottom >= contentOffsetBottom)) {
        // $('.toc').css('visibility', 'hidden')
        $('.toc').addClass("toc-hidden")
      }
      else if (scrollTop >= contentOffsetTop) {
        $(".toc").removeClass("toc-hidden")
      }
  });
</script>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-9 mx-auto">
        <ul class="list-inline text-center">
          
          
          
          <li class="list-inline-item">
            <a href="https://www.facebook.com/socarsharing">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; SOCAR 2023 | tech_branding@socar.kr</p>
      </div>
    </div>
  </div>
</footer>


  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>
<script src="/assets/scripts.js"></script>
<script src="/assets/mermaid-8.2.3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30551922-27"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-30551922-27');
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MZ79TFM');</script>
<!-- End Google Tag Manager -->


</body>

</html>

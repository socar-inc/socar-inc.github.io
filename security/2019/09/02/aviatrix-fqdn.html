<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>
    AWS VPCì—ì„œ FQDN Outbound Control - SOCAR Tech Blog
    
  </title>

  <meta name="description" content="Aviatrix Gatewayë¥¼ ì´ìš©í•œ FQDN Outbound Control">

  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://tech.socarcorp.kr/security/2019/09/02/aviatrix-fqdn.html"/>
  <meta property="og:title" content="AWS VPCì—ì„œ FQDN Outbound Control"/>
  <meta property="og:description" content="Aviatrix Gatewayë¥¼ ì´ìš©í•œ FQDN Outbound Control"/>
  <meta property="og:site_name" content="SOCAR Tech Blog"/>
  <meta property="og:image" content="https://tech.socarcorp.kr/img/big_wheel.jpg"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="AWS VPCì—ì„œ FQDN Outbound Control"/>
  <meta name="twitter:description" content="Aviatrix Gatewayë¥¼ ì´ìš©í•œ FQDN Outbound Control"/>
  <meta name="twitter:image" content="https://tech.socarcorp.kr/img/big_wheel.jpg"/>


  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">

  <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/vendor/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="/assets/main.css">

  <link rel="canonical" href="https://tech.socarcorp.kr/security/2019/09/02/aviatrix-fqdn.html">
  <link rel="alternate" type="application/rss+xml" title="SOCAR Tech Blog" href="/feed.xml">
  <link rel="icon" type="image/png" href="/assets/icon/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icon/favicon-96x96.png">
</head>


<body>

  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">SOCAR Tech Blog</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fa fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">ğŸ  Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/posts">âœï¸ Posts</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/categories">ğŸ“” Categories</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/tags">ğŸ· Tags</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/authors">âœğŸ» Authors</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->

<header class="masthead" style="background-image: url('/img/big_wheel.jpg')">
  
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-9 col-md-9 mx-auto">
          <div class="post-heading">
            <h1 class="post-title">AWS VPCì—ì„œ FQDN Outbound Control</h1>
            
            <h2 class="subheading">Aviatrix Gatewayë¥¼ ì´ìš©í•œ FQDN Outbound Control</h2>
            
            <div class="post-meta">
              
              
                
                <span class="author"><a href="/authors#ì•„ì´ì‘"><img src="/assets/authors/default.png">ì•„ì´ì‘</a></span>
              
                <br>
                <span class="date">2019-09-02</span>
                <br>
                <span class="category"><a href="/categories#">security</a></span> 
                <br>
              
                <span class="tag"><a href="/tags#outbound">outbound</a></span>
              
                <span class="tag"><a href="/tags#aviatrix">aviatrix</a></span>
              
                <span class="tag"><a href="/tags#fqdn">fqdn</a></span>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="toc toc-hidden" id="toc">
    </div>
    <div class="row">
      <div class="col-lg-9 col-md-9 mx-auto">
        <div class="post-content">
        <div class="photo-copyright">
Photo by <a href="https://unsplash.com/@andreoiide?utm_medium=referral&amp;utm_campaign=photographer-credit&amp;utm_content=creditBadge">Andrea EnrÃ­quez CousiÃ±o</a>
</div>

<p><strong>On-premise</strong> í™˜ê²½ì—ì„œ í˜„ì¬ íšŒì‚¬ì˜ ì„±ì¥ì„¸ë¥¼ ë”°ë¼ê°€ê¸° ì–´ë µë‹¤ê³  íŒë‹¨í•˜ê³ , 1ë…„ ì „ë¶€í„° Cloud í™˜ê²½ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤. í˜„ì¬ëŠ” ì¤‘ìš” ì„œë¹„ìŠ¤ì˜ 90% ì´ìƒì´ Cloud í™˜ê²½ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë˜ì—ˆìœ¼ë©°, ê·¸ ê³¼ì •ì—ì„œ ì¸í”„ë¼ë¥¼ êµ¬ì„±í•˜ëŠ” ë§ì€ êµ¬ì„± ìš”ì†Œê°€ ë³€ê²½, ëŒ€ì²´ ë˜ì—ˆìŠµë‹ˆë‹¤. ë˜í•œ, ì—¬ëŸ¬ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±ì‹œí‚¤ê¸° ìœ„í•´ì„œ ì¶”ê°€ì ì¸ ì‹œìŠ¤í…œ ë„ì…ì— ëŒ€í•´ì„œ ê³ ë¯¼í•˜ì˜€ê³ , ê·¸ ê³¼ì •ì„ ê³µìœ í•˜ê³ ì í•©ë‹ˆë‹¤.</p>

<h2 id="ëª©ì°¨">ëª©ì°¨</h2>

<ul>
  <li>Outbound FQDN filteringì„ í•˜ë ¤ëŠ” ì´ìœ </li>
  <li>Cloud í™˜ê²½ì—ì„œ Outbound íŠ¸ë˜í”½ì— ëŒ€í•œ ê´€ë¦¬ë¥¼ ì–´ë–»ê²Œ í• ê¹Œ?</li>
  <li>Aviatrix ì†”ë£¨ì…˜ êµ¬ì¶•ì„ í†µí•œ ìš”êµ¬ì‚¬í•­ ê²€í†  (AWS)</li>
  <li>AWS Account with Aviatrix Gateway Architecture</li>
  <li>Aviatrix ìì„¸íˆ ë“¤ì—¬ë‹¤ë³´ê¸°</li>
  <li>Multiple AWS Accounts with Role Switchin Aviatrix Architecture</li>
  <li>ì •ë¦¬</li>
  <li>ê³„íšì¤‘ì¸ Aviatrixì„ ì´ìš©í•œ ë‹¤ì–‘í•œ í™˜ê²½ êµ¬ì¶•</li>
</ul>

<hr />

<h2 id="outbound-fqdn-filteringì„-í•˜ë ¤ëŠ”-ì´ìœ ">Outbound FQDN filteringì„ í•˜ë ¤ëŠ” ì´ìœ </h2>
<ul>
  <li><code class="highlighter-rouge">ë©€ì›¨ì–´ 2ì°¨ í™•ì‚° ë°©ì§€</code>
    <ul>
      <li>ë©€ì›¨ì–´ì— ê°ì—¼ëœ ê²½ìš° Outbound FQDN Filteringì„ í†µí•´ ë©€ì›¨ì–´ <a href="https://ko.wikipedia.org/wiki/C%26C_(%EC%95%85%EC%84%B1_%EC%86%8C%ED%94%84%ED%8A%B8%EC%9B%A8%EC%96%B4)">C&amp;C</a> ì„œë²„ì— ì—°ê²°í•˜ì§€ ëª»í•˜ê²Œ í•˜ê³ , <u>ì•…ì„± ì½”ë“œ</u>ê°€ ì»´í“¨í„°ì˜ ë°ì´í„°ë¥¼ ì™¸ë¶€ë¡œ ì „ì†¡í•˜ë ¤ê³  í•˜ë©´ ëŒ€ìƒì— ì—°ê²°í•˜ì§€ ëª»í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ul>
  </li>
  <li>Outbound íŠ¸ë˜í”½ì— ëŒ€í•œ ë¬´ë‹¨ í™œë™ ê°ì§€</li>
  <li>google.com ë“± <strong>IP Range</strong>ê°€ ë„“ê³ , <a href="https://en.wikipedia.org/wiki/Content_delivery_network">CDN</a> ì„œë¹„ìŠ¤ ê°™ì€ ì§€ì† í•´ì„œ ë³€í•˜ëŠ” IP ëŒ€ì‘</li>
  <li>AWS - Security Groups ê¸°ì¤€ Inbound or outbound rules per security groupì€ 60ê°œë¡œ <a href="https://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html">ì œí•œ</a> ë©ë‹ˆë‹¤. Inbound ê´€ì ì—ì„œ ì¸í„°ë„·ì—ì„œ ê³ ê° ì„œë¹„ìŠ¤ëŠ” íŠ¹ì´ì‚¬í•­ì´ ì•„ë‹ ìˆ˜ ìˆìœ¼ë‚˜, Outbound ê´€ì ì—ì„œëŠ” updates.ubuntu.com(IP 15), Github(IP 12) ë“± íƒ€ì‚¬ì˜ ì—…ë°ì´íŠ¸ ë° APIë¥¼ ìƒê°í•˜ë©´ <u>60ê°œì˜ IP ì œí•œì€ ì¶©ë¶„í•˜ì§€ ì•Šë‹¤</u>ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="cloud-í™˜ê²½ì—ì„œ-outbound-íŠ¸ë˜í”½ì—-ëŒ€í•œ-ê´€ë¦¬ë¥¼-ì–´ë–»ê²Œ-í• ê¹Œ">Cloud í™˜ê²½ì—ì„œ Outbound íŠ¸ë˜í”½ì— ëŒ€í•œ ê´€ë¦¬ë¥¼ ì–´ë–»ê²Œ í• ê¹Œ?</h2>
<ul>
  <li>Cloud Platformì—ì„œ <u>TCP/IP</u> Outboundì— ëŒ€í•´ì„œëŠ” ë¡œê·¸ ë° ê´€ë¦¬ë¥¼ ë‹¤ì–‘í•œ Management Serviceë¡œ ì§€ì›í•˜ê³  ìˆì§€ë§Œ, Outbound íŠ¸ë˜í”½ ì¤‘ì— IP ì£¼ì†Œê°€ ì•„ë‹Œ <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name"><strong>FQDN</strong></a>ì„ ê¸°ì¤€ìœ¼ë¡œ í•œ Filteringì— ëŒ€í•œ ì§€ì›ì€ Management Service ë§Œìœ¼ë¡œ ëŒ€ì²˜ê°€ ì–´ë µë‹¤ê³  íŒë‹¨í•˜ì—¬ ë³„ë„ì˜ ì†”ë£¨ì…˜ ë„ì…ì„ ê³„íší•˜ê²Œ ë˜ì—ˆê³ , ë‹¤ìŒê³¼ ê°™ì´ ìš”êµ¬ì‚¬í•­ì„ ì •ë¦¬í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">*</span> Outbound - FQDN filtering +@(TCP/IP)
<span class="p">*</span> HTTP/HTTPS +@((Wildcard)<span class="err">*</span>.domain.com)
<span class="p">*</span> Multiple Accounts and Cloud Platform Support
<span class="p">*</span> í™•ì¥ì„±, ê´€ë¦¬ í¸ì˜ì„± (Infrastructure as code, Update)
<span class="p">*</span> ì•ˆì •ì„± (ë‹¤ì–‘í•œ ë ˆí¼ëŸ°ìŠ¤, Monitoring, HA)
<span class="p">*</span> ë¹„ìš© (ì €ë ´í•œ êµ¬ì¶•/ë¼ì´ì„¼ìŠ¤ ë¹„ìš©)
</code></pre></div></div>

<p>ê·¸ ì´í›„ì—ëŠ” ì˜¤í”ˆì†ŒìŠ¤(<a href="https://aws.amazon.com/ko/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/">Squid</a>), ìœ ë£Œ ì†”ë£¨ì…˜(<a href="https://aws.amazon.com/marketplace/pp/B00PJ2V04O?qid=1567422902264&amp;sr=0-2&amp;ref_=srh_res_product_title">paloalto</a>, <a href="https://aws.amazon.com/marketplace/pp/B01N49IN0S?qid=1567422994913&amp;sr=0-16&amp;ref_=srh_res_product_title">Cisco vMX</a> ë“±)ì„ ê²€í†  í•˜ì˜€ê³ , ê·¸ ì¤‘ êµ­ë‚´ì—ì„œëŠ” ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì°¾ì•„ë³´ê¸° ì‰½ì§€ ì•Šì§€ë§Œ <a href="https://aws.amazon.com/marketplace/pp/B079T2HGWG?qid=1567423038998&amp;sr=0-1&amp;ref_=srh_res_product_title"><code class="highlighter-rouge">Aviatrix</code></a> ìœ ë£Œ ì†”ë£¨ì…˜ì„ ì„ ì •í•˜ì˜€ìŠµë‹ˆë‹¤. ì„ ì • ê³¼ì •ì—ì„œ í™•ì¸í•´ë³¸ ê²°ê³¼ <u>í•´ì™¸ ë ˆí¼ëŸ°ìŠ¤</u>ì˜ ê²½ìš°ì—ëŠ” NASA, Netflix, Hyatt ë“±ì´ ìˆì—ˆìœ¼ë©°, ìš”êµ¬ ì‚¬í•­ì—ì„œ í•„ìš”ë¡œ í•˜ëŠ” <strong>Service(FQDN, TransitGW, VPN)ì— ëŒ€í•œ</strong> ë¹„ìš© ë° <a href="https://en.wikipedia.org/wiki/Infrastructure_as_code">IaC</a> ë°°í¬, êµ¬ì„±ì´ íƒ€ ìœ ë£Œ ì†”ë£¨ì…˜ë³´ë‹¤ ì´ì ì´ ìˆë‹¤ëŠ” ê²ƒì„ ê°ì•ˆí•˜ì—¬ Aviatrixì„ ì„ ì •í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì„ ì • ê³¼ì •ì—ì„œ ì°¸ê³ ë¡œ í•œ ìë£ŒëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>

<ul>
  <li><a href="https://aws.amazon.com/quickstart/architecture/aviatrix-fqdn-egress-filtering/?nc1=h_ls">AWS ê¸°ë°˜ Aviatrix FQDN Egress Filtering</a></li>
  <li><a href="https://www.aviatrix.com/solutions/egress-security.php">Controlling Outbound VPC Traffic</a></li>
  <li><a href="https://aws.amazon.com/answers/networking/controlling-vpc-egress-traffic/">AWS Answers - Controlling VPC Egress Traffic</a></li>
</ul>

<hr />

<h2 id="aviatrix-ì†”ë£¨ì…˜-êµ¬ì¶•ì„-í†µí•œ-ìš”êµ¬ì‚¬í•­-ê²€í† -aws">Aviatrix ì†”ë£¨ì…˜ êµ¬ì¶•ì„ í†µí•œ ìš”êµ¬ì‚¬í•­ ê²€í†  (AWS)</h2>

<p>Aviatrix ì†”ë£¨ì…˜ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´, AWS Marketplaceì—ì„œ Aviatrixì„ ì„ íƒ í›„ <strong>Free Trial</strong> ì´ìš©ì´ ê°€ëŠ¥í•œ Custom ìœ í˜•ì„ ì„ íƒí•˜ì—¬ í…ŒìŠ¤íŠ¸ ì´ˆê¸° í™˜ê²½ì„ êµ¬ì„±í•©ë‹ˆë‹¤. <strong>AWS ì¸í”„ë¼(EC2 ë“±) ì‚¬ìš© ê¸ˆì•¡ì´ ë°œìƒ</strong>í•˜ê¸° ë•Œë¬¸ì— EC2 Instanc Typeì€ <strong>ìµœì†Œ ìŠ¤í™</strong>ì„ ì„ íƒí•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</p>
<ul>
  <li><a href="https://aws.amazon.com/marketplace/pp/B0155GB0MA?ref_=aws-mp-console-subscription-detail">AWS-Marketplace (Aviatrix Secure Networking Platform - Custom)</a></li>
</ul>

<p>ì„¤ì¹˜ ë°©ë²•ì€ ë‘ê°€ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
<img src="/img/posts_aviatrix/cloudformation-image.png" alt="1" /></p>

<ol>
  <li>Amazon Machine Image (AMI)ë¥¼ í†µí•œ ì§ì ‘ ì„¤ì¹˜</li>
  <li>CloudFormation Templateì„ ì´ìš©í•œ ìë™í™”ëœ ì„¤ì¹˜</li>
</ol>

<p>ì›í™œí•œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ CloudFormation Templateì„ ì„ íƒí•˜ì—¬ ì§„í–‰í•©ë‹ˆë‹¤. Amazon Machine Imageë¥¼ í†µí•œ êµ¬ì„± ì‹œì—ëŠ” Role, Network êµ¬ì„± ë“±ì˜ ì¶”ê°€ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ìƒì„¸ ì„¤ì¹˜ ê³¼ì •ì€ Aviatrixì—ì„œ Guideë¥¼ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. <code class="highlighter-rouge">(CloudFormation Template ì˜ IAM Role, Policy ë“±ì€ ì•„ë˜ì— ë³„ë„ ë¶„ì„í•˜ê² ìŠµë‹ˆë‹¤.)</code></p>
<ul>
  <li><a href="https://docs.aviatrix.com/StartUpGuides/aviatrix-cloud-controller-startup-guide.html">Aviatrix CloudFormation Template Guide</a></li>
</ul>

<p>CloudFormation ë°°í¬ê°€ ì™„ë£Œëœ ìƒíƒœì—ì„œ Output ì¹´í…Œê³ ë¦¬ì—ì„œ AviatrixControllerEIP ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. EIPì— ëŒ€í•œ êµ¬ì„±ì„ í•˜ì§€ ì•Šì„ ê²½ìš°ì—ëŠ” AviatrixControllerPrivateIP ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ ì›¹ í˜ì´ì§€ ì£¼ì†Œë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤. PrivateIPëŠ” <strong>ì´ˆê¸° ì„ì‹œ íŒ¨ìŠ¤ì›Œë“œ</strong>ë¡œë„ êµ¬ì„±ë©ë‹ˆë‹¤.</p>
<ul>
  <li>https://AviatrixControllerEIP</li>
</ul>

<p><img src="/img/posts_aviatrix/cloudformation-output.png" alt="2" /></p>

<p>AviatrixControllerEIP ì ‘ì† ì´í›„ ê´€ë¦¬ì ì•„ì´ë”” ë° ë²„ì „ì„ ì„¤ì •í•©ë‹ˆë‹¤.<br />
ì„¤ì •ì„ ì™„ë£Œí•  ê²½ìš°ì—ëŠ” ì´ˆê¸° ë¡œê·¸ì¸í™”ë©´ì—ì„œ Onboarding í™”ë©´ì´ ë…¸ì¶œë©ë‹ˆë‹¤.<br />
í™”ë©´ì—ì„œ ì´ìš©í•˜ê³  ìˆëŠ” Cloud Platformì„ ì§€ì •í•˜ê³  ì¶”ê°€ì ì¸ ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤.</p>

<p>ëª¨ë“  ì„¤ì •ì„ ì™„ë£Œí•œ ì´í›„ì— ì œê³µë˜ëŠ” Aviatrixì˜ ì‚¬ìš©ì í˜ì´ì§€ ì…ë‹ˆë‹¤.
<img src="/img/posts_aviatrix/aviatrix-1.png" alt="3" />
EC2 ì˜ Outbound íŠ¸ë˜í”½ì„ ë¡œê¹… ë° ê´€ë¦¬í•˜ê¸° ìœ„í•´ì„œ ìš°ì„ ì ìœ¼ë¡œ Gatewayì˜ ì„¤ì •ì´ í•„ìš”í•´ì„œ, Aviatrix ì‚¬ìš©ì ì¹´í…Œê³ ë¦¬ì—ì„œ Gateway ì„¤ì •ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>

<p>New Gateway ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤.
<img src="/img/posts_aviatrix/aviatrix-gw-add.png" alt="10" />
â€œOKâ€ë¥¼ í´ë¦­í•  ê²½ìš° í¼ì„¼íŠ¸ì— ëŒ€í•œ ìƒíƒœ ì´ë¯¸ì§€ê°€ ë…¸ì¶œë©ë‹ˆë‹¤. ì´í›„ ì‘ì—…ì€ ì§ì ‘ ì„¤ì¹˜ë¥¼ ì§„í–‰í•˜ì§€ ì•Šì•„ë„ ìë™ ì„¤ì¹˜ ë° Gateway ì„œë²„ì— ëŒ€í•œ í™˜ê²½ì´ êµ¬ì„±ë©ë‹ˆë‹¤. <code class="highlighter-rouge">(HA êµ¬ì„±ì˜ ê²½ìš°ì—ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì„ ì œê³µí•˜ê³  ìˆì–´ ì•„ë˜ ë§í¬ë¥¼ ì¶”ê°€í•´ ë“œë¦½ë‹ˆë‹¤, Aviatrix ê¹Šê²Œ ë“¤ì—¬ë‹¤ë³´ê¸°(HA, Egress FQDN Discovery) ë‚´ìš©ì€ ë¸”ë¡œê·¸ í•˜ë‹¨ì— ë¶„ë¥˜í•˜ì˜€ìŠµë‹ˆë‹¤.)</code></p>
<ul>
  <li><a href="https://docs.aviatrix.com/HowTos/gateway.html"><code class="highlighter-rouge">Gateway</code></a></li>
  <li><a href="https://docs.aviatrix.com/HowTos/gateway.html#gateway-single-az-ha"><code class="highlighter-rouge">Gateway-HA</code></a></li>
  <li><a href="https://docs.aviatrix.com/Solutions/gateway_ha.html"><code class="highlighter-rouge">HA-ì˜µì…˜</code></a></li>
</ul>

<p>Private Subnetì˜ Route Tableì„ ìƒì„±í•´, ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” ëª¨ë“  íŠ¸ë˜í”½ì´ Aviatrix-GWë¥¼ í†µí•´ì„œ ë‚˜ê°€ë„ë¡ ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤. <code class="highlighter-rouge">"0.0.0.0/0"</code> ì— ëŒ€í•œ Targetì„ Aviatrix-GW <u>ENI</u>ë¡œ ì§€ì •í•©ë‹ˆë‹¤. ìë™ ë“±ë¡ì„ ì›í•  ê²½ìš° Aviatrix Controller ì‚¬ìš©ì ì›¹ í˜ì´ì§€ì—ì„œ <code class="highlighter-rouge">Gateway &gt; Aviatrix-GW: Edit &gt; Source NAT</code>ë¥¼ í†µí•œ ì„¤ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
<img src="/img/posts_aviatrix/route-table-avi.png" alt="11" /></p>

<p>FQDN ë¡œê¹… ë° ê´€ë¦¬ë¥¼ ìœ„í•´, Aviatrix Controller ì‚¬ìš©ì ì›¹ í˜ì´ì§€ì—ì„œ <strong>security &gt; Egress Control &gt; Egress FQDN Filter</strong>ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</p>

<ol>
  <li>Egress FQDN Filter ìƒì„± White List/Black List &gt; Black ì§€ì •</li>
  <li>ì´í›„ <strong>ì‹¤ ì„œë²„ í™˜ê²½</strong> ë„ì…ì˜ ê²½ìš° Egress FQDN View Logë¥¼ í™•ì¸í•˜ê³ , ì‚¬ìš©í•˜ê³  ìˆëŠ” FQDNì„ ë³´ì•ˆì„±ì— ë§ë„ë¡ ë¶„ë¦¬í•˜ì—¬, Egress FQDN Filterë¥¼ White Listê¸°ë°˜ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ ì‚¬ì „ì— ëŒ€ë¹„í•©ë‹ˆë‹¤.</li>
</ol>

<p>í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ì„œ FQDN Filterë¥¼ ì•„ë˜ì˜ ì´ë¯¸ì§€ì™€ ê°™ì´ <u>White</u> ì„¤ì •í•œ ì´í›„ì—, Aviatrix-GWë¥¼ ë°”ë¼ ë³´ê³  ìˆëŠ” <code class="highlighter-rouge">Private-route-table</code> ì˜ <code class="highlighter-rouge">Private-Subnet</code>ì—ì„œ ìš´ì˜ë˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì˜€ìŠµë‹ˆë‹¤.
<img src="/img/posts_aviatrix/fqdn-list.png" alt="12" /></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> <span class="nt">-k</span> <span class="nt">-s</span> <span class="nt">-o</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> https://www.naver.com
curl <span class="nt">-L</span> <span class="nt">-k</span> <span class="nt">-s</span> <span class="nt">-o</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> https://google.com
curl <span class="nt">-L</span> <span class="nt">-k</span> <span class="nt">-s</span> <span class="nt">-o</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> https://www.google.com
curl <span class="nt">-L</span> <span class="nt">-k</span> <span class="nt">-s</span> <span class="nt">-o</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> https://docs.google.com
</code></pre></div></div>
<p>í…ŒìŠ¤íŠ¸ì— ëŒ€í•œ Egress FQDN View Log</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="m">2019-09-01</span><span class="n">T16</span><span class="o">:</span><span class="m">40</span><span class="o">:</span><span class="m">35.886612+00</span><span class="o">:</span><span class="m">00</span><span class="w"> </span><span class="n">ip</span><span class="m">-172-31-14-85</span><span class="w"> </span><span class="n">avx</span><span class="o">-</span><span class="n">nfq</span><span class="o">:</span><span class="w"> </span><span class="n">AviatrixFQDNRule</span><span class="p">[</span><span class="n">CRIT</span><span class="p">]</span><span class="n">nfq_ssl_handle_client_hello</span><span class="p">()</span><span class="w"> </span><span class="n">L</span><span class="c1">#274  Gateway=Aviatrix-GW S_IP=172.31.24.52 D_IP=210.89.164.90 hostname=www.naver.com state=NO_MATCH drop_reason=NOT_WHITELISTED</span><span class="w">
</span><span class="m">2019-09-01</span><span class="n">T16</span><span class="o">:</span><span class="m">40</span><span class="o">:</span><span class="m">53.442375+00</span><span class="o">:</span><span class="m">00</span><span class="w"> </span><span class="n">ip</span><span class="m">-172-31-14-85</span><span class="w"> </span><span class="n">avx</span><span class="o">-</span><span class="n">nfq</span><span class="o">:</span><span class="w"> </span><span class="n">AviatrixFQDNRule</span><span class="p">[</span><span class="n">CRIT</span><span class="p">]</span><span class="n">nfq_ssl_handle_client_hello</span><span class="p">()</span><span class="w"> </span><span class="n">L</span><span class="c1">#274  Gateway=Aviatrix-GW S_IP=172.31.24.52 D_IP=172.217.27.78 hostname=google.com state=MATCHED</span><span class="w">
</span><span class="m">2019-09-01</span><span class="n">T16</span><span class="o">:</span><span class="m">40</span><span class="o">:</span><span class="m">53.654101+00</span><span class="o">:</span><span class="m">00</span><span class="w"> </span><span class="n">ip</span><span class="m">-172-31-14-85</span><span class="w"> </span><span class="n">avx</span><span class="o">-</span><span class="n">nfq</span><span class="o">:</span><span class="w"> </span><span class="n">AviatrixFQDNRule</span><span class="p">[</span><span class="n">CRIT</span><span class="p">]</span><span class="n">nfq_ssl_handle_client_hello</span><span class="p">()</span><span class="w"> </span><span class="n">L</span><span class="c1">#274  Gateway=Aviatrix-GW S_IP=172.31.24.52 D_IP=216.58.197.164 hostname=www.google.com state=MATCHED</span><span class="w">
</span><span class="m">2019-09-01</span><span class="n">T16</span><span class="o">:</span><span class="m">40</span><span class="o">:</span><span class="m">58.707731+00</span><span class="o">:</span><span class="m">00</span><span class="w"> </span><span class="n">ip</span><span class="m">-172-31-14-85</span><span class="w"> </span><span class="n">avx</span><span class="o">-</span><span class="n">nfq</span><span class="o">:</span><span class="w"> </span><span class="n">AviatrixFQDNRule</span><span class="p">[</span><span class="n">CRIT</span><span class="p">]</span><span class="n">check_ip</span><span class="p">()</span><span class="w"> </span><span class="n">L</span><span class="c1">#65  Gateway=Aviatrix-GW S_IP=172.31.24.52 D_IP=216.58.197.164 hostname=www.google.com state=MATCHED</span><span class="w">
</span><span class="m">2019-09-01</span><span class="n">T16</span><span class="o">:</span><span class="m">41</span><span class="o">:</span><span class="m">21.940692+00</span><span class="o">:</span><span class="m">00</span><span class="w"> </span><span class="n">ip</span><span class="m">-172-31-14-85</span><span class="w"> </span><span class="n">avx</span><span class="o">-</span><span class="n">nfq</span><span class="o">:</span><span class="w"> </span><span class="n">AviatrixFQDNRule</span><span class="p">[</span><span class="n">CRIT</span><span class="p">]</span><span class="n">nfq_ssl_handle_client_hello</span><span class="p">()</span><span class="w"> </span><span class="n">L</span><span class="c1">#274  Gateway=Aviatrix-GW S_IP=172.31.24.52 D_IP=172.217.26.14 hostname=docs.google.com state=MATCHED</span><span class="w">
</span><span class="m">2019-09-01</span><span class="n">T16</span><span class="o">:</span><span class="m">41</span><span class="o">:</span><span class="m">22.323298+00</span><span class="o">:</span><span class="m">00</span><span class="w"> </span><span class="n">ip</span><span class="m">-172-31-14-85</span><span class="w"> </span><span class="n">avx</span><span class="o">-</span><span class="n">nfq</span><span class="o">:</span><span class="w"> </span><span class="n">AviatrixFQDNRule</span><span class="p">[</span><span class="n">CRIT</span><span class="p">]</span><span class="n">nfq_ssl_handle_client_hello</span><span class="p">()</span><span class="w"> </span><span class="n">L</span><span class="c1">#274  Gateway=Aviatrix-GW S_IP=172.31.24.52 D_IP=172.217.25.77 hostname=accounts.google.com state=MATCHED</span><span class="w">
</span></code></pre></div></div>
<p>ë¡œê·¸ë¥¼ í†µí•´ <strong>state</strong>ë¥¼ í™•ì¸í•˜ê³  í›„ì† ì¡°ì¹˜ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. Aviatrix ì„œë¹„ìŠ¤ì— ëŒ€í•œ ë‹¤ì–‘í•œ ë¡œê·¸ ê´€ë¦¬ ë° ì‹œê°í™” ë“±ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì—, ë³„ë„ ì¶”ê°€ë¡œ í™•ì¸í•˜ê³  ì‹¶ìœ¼ì‹  ë‚´ìš©ì€ ì•„ë˜ì˜ ë§í¬ì—ì„œ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
<ul>
  <li><a href="https://docs.aviatrix.com/HowTos/AviatrixLogging.html">Aviatrix-Logging</a></li>
</ul>

<p>ìœ„ ë‚´ìš©ì—ì„œ google.com FQDNì— ëŒ€í•´ì„œ <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">í˜¸ìŠ¤íŠ¸ ëª…</a>ì„ ì§€ì •í•˜ì§€ ì•Šì„ ë•Œì—ëŠ” <code class="highlighter-rouge">"*"</code>ë¡œ ì ìš©ë©ë‹ˆë‹¤. (*.google.com = google.com)</p>

<hr />

<h2 id="aws-account-with-aviatrix-gateway-architecture">AWS Account with Aviatrix Gateway Architecture</h2>

<p><img src="/img/posts_aviatrix/fqdn-architecture.png" alt="13" /></p>

<p>Instance Outbound Flow &amp; Aviatrix Controller Gateway HA Flow</p>

<div class="mermaid">
graph LR;
  CLIENT[ì‹œì‘: Instance] --&gt;|1.Private  Route Table| ag(Aviatrix Gateway)
    ag --&gt;|2. Public Route Table| igw(Internet Gateway)
    igw --&gt;|3| int[Internet]
    ac(ì‹œì‘: Aviatrix Controller) --&gt; internet2[Internet]
    internet2[Internet]--&gt;|Health Check| ag
    internet2[Internet]--&gt;|Health Check| agha(Aviatrix Gateway HA)
    ag--&gt;|Failover| agha(Aviatrix Gateway HA)
    agha--&gt;|Failover| ag
</div>

<ol>
  <li>Private Subnetì—ì„œì˜ Outbound ë°œìƒ ì‹œ ìì²´ ì„¤ì •í•œ <code class="highlighter-rouge">Route table</code>ì„ ì°¸ì¡°</li>
  <li>Route tableì—ì„œ <code class="highlighter-rouge">"0.0.0.0/0"</code> í†µì‹ ì„ Aviatrix Gatewayì˜ <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html"><code class="highlighter-rouge">ENI</code></a>ë¡œ ì „ë‹¬</li>
  <li>Aviatrix Gatewayì— ì„¤ì •ë˜ì–´ìˆëŠ” <code class="highlighter-rouge">Aviatrix Controller</code> ì •ì±…ì— ë”°ë¼ Outbound íŠ¸ë˜í”½ ì²´í¬ ì´í›„ì—, Aviatrix Gatewayì— Internet gatewayë¡œ ì „ë‹¬</li>
  <li>Internet Gatewayì„ ìš”ì²­í•œ í†µì‹ ì„ ì™¸ë¶€(Internet)ë¡œ ì „ë‹¬</li>
  <li>Aviatrix Controllerì˜ ê²½ìš° Internetì„ í†µí•´ Aviatrix Gateway Health Check</li>
  <li>Aviatrix Gateway ì¥ì•  ë°œìƒì‹œ Gateway_HAì˜ <u>ENI</u>ë¡œ Private Subnetì˜ <code class="highlighter-rouge">Route table</code> <code class="highlighter-rouge">"0.0.0.0/0"</code> ì—…ë°ì´íŠ¸</li>
</ol>

<hr />

<h2 id="aviatrix-ìì„¸íˆ-ë“¤ì—¬ë‹¤ë³´ê¸°">Aviatrix ìì„¸íˆ ë“¤ì—¬ë‹¤ë³´ê¸°</h2>

<h3 id="1-hahigh-availability">1. <a href="https://en.wikipedia.org/wiki/High_availability">HA(High Availability)</a></h3>
<p>HA êµ¬ì„±ì€ ëª¨ë“  ì¸í”„ë¼ì˜ <strong>ê¸°ë³¸</strong>ìœ¼ë¡œ Aviatrixì„ ì‚¬ìš©í•  ê²½ìš° ì•„ë˜ì™€ ê°™ì€ ê°„ë‹¨í•œ ì‘ì—…ìœ¼ë¡œ ì ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

<p>Gateway &gt; Edit &gt; Gateway Single AZ HA â€œEnableâ€<br />
Gateway &gt; Edit &gt; Gateway for High Availability Peering<br />
(HA êµ¬ì„±ì„ ìœ„í•´ <u>ìš´ì˜</u> ì¤‘ì¸ Gateway Subnetê³¼ ë‹¤ë¥¸ <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">AZ</a>ì˜ <u>Public-Subnet</u>ì„ ì„ íƒí•©ë‹ˆë‹¤.)</p>

<p><img src="/img/posts_aviatrix/gateway-ha-public-b.png" alt="20" /></p>

<p>HA êµ¬ì„±ì„ ìœ„í•œ ì„¤ì •ì€ ë§ˆë¬´ë¦¬í•˜ì˜€ìœ¼ë©°, ì •ìƒì ìœ¼ë¡œ <strong>Failover</strong>ê°€ ë˜ëŠ”ì§€ í™•ì¸ì„ ìœ„í•´ ì•„ë˜ êµ¬ì„±ì„ ì§„í–‰í•˜ì˜€ìŠµë‹ˆë‹¤.</p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">*</span> Private-Subnetì—ì„œ ìš´ì˜ë˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì„¤ì •
<span class="p">*</span> Failover ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ Aviatrix-GW ì¸ìŠ¤í„´ìŠ¤ë¥¼ AWS Consoleì—ì„œ ê°•ì œ ì¢…ë£Œ(STOP)
<span class="p">*</span> Private-Subnetì—ì„œ ìš´ì˜ë˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì§€í‘œ í™•ì¸
</code></pre></div></div>

<p><u>Failover</u>ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ì „ì˜ Aviatrix Gateway ìƒíƒœ ì´ë¯¸ì§€ì…ë‹ˆë‹¤.</p>

<p><img src="/img/posts_aviatrix/gateway-status.png" alt="21" />
<u>Failover</u>ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ Gatewayë¥¼ ê°•ì œ ì¢…ë£Œí•œ Aviatrix Gateway ìƒíƒœ ì´ë¯¸ì§€ì…ë‹ˆë‹¤.</p>

<p><img src="/img/posts_aviatrix/gateway-status-2.png" alt="22" /></p>

<p>í…ŒìŠ¤íŠ¸ ê²°ê³¼: Private-Subnetì—ì„œ ìš´ì˜ë˜ê³  ìˆëŠ” ì¸ìŠ¤í„´ìŠ¤ì— ëª¨ë‹ˆí„°ë§ ì—ì´ì „íŠ¸(Telegraf)ë¥¼ ì„¤ì •í•˜ì—¬, ICMP í”„ë¡œí† ì½œì„ ì´ìš©í•œ <u>1s</u> ê¸°ì¤€ìœ¼ë¡œ <strong>Packet Loss</strong> í˜„ìƒì´ ë°œìƒ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì›¹ì‚¬ì´íŠ¸ ê¸°ì¤€ì—ì„œëŠ” Gatewayê°€ Failover ë˜ëŠ” ì‹œì ì„ ì¸ì§€í•  ìˆ˜ ì—†ëŠ” ì •ë„ì…ë‹ˆë‹¤.</p>

<p><img src="/img/posts_aviatrix/monitoring.png" alt="23" /></p>

<ul>
  <li><code class="highlighter-rouge">Aviatrix-Gateway HA Flow (Failover)</code></li>
</ul>

<div class="mermaid">
graph TB
    subgraph Public_A
Controller[Controller]
end
    Controller -x |1.Health Check ì‹¤íŒ¨|Gateway
    Controller -x |2.AWS-Roleì„ ì´ìš©í•œ table update|Private_Routetable
    Private_Routetable -x |3.traffic|Gateway_HA
    Controller--&gt;|Health Check |Gateway
    Controller--&gt;|Health Check|Gateway_HA
    subgraph Public
    subgraph Public_B
Gateway[Gateway]
end
    Gateway--&gt;Public_Routetable
    subgraph Public_C
Gateway_HA[Gateway_HA]
end
end
    Gateway_HA--&gt;Public_Routetable
    subgraph Private
    subgraph Private_A
Instance-A[Instance-A]
end
    Instance-A--&gt;Private_Routetable
    subgraph Private_B
Instance-B[Instance-B]
end
    Instance-B--&gt;Private_Routetable
    Private_Routetable--&gt;Gateway
end
    Public_Routetable--&gt;Internet
</div>

<ul>
  <li>AviatrixController -&gt; Gateway [Health Check] -&gt; <code class="highlighter-rouge">Fail</code></li>
  <li>Gateway_HAë¡œ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ë³€ê²½
    <ul>
      <li>ë¬¸ì œ ë˜ëŠ” Gatewayë¡œ ì„¤ì •ë˜ì–´ ìˆë˜ Route Table ì—…ë°ì´íŠ¸</li>
      <li>ì˜ˆ) Private-Subnet &gt; Route Table &gt; <code class="highlighter-rouge">"0.0.0.0/0"</code> Target <code class="highlighter-rouge">Gateway_HA</code> ENIë¡œ ì—…ë°ì´íŠ¸</li>
    </ul>
  </li>
</ul>

<h3 id="2-egress-fqdn-discovery">2. <a href="https://docs.aviatrix.com/HowTos/fqdn_discovery.html">Egress FQDN Discovery</a></h3>

<p>í•´ë‹¹ ê¸°ëŠ¥ì€ <strong>ì‹¤ ì„œë²„</strong>ì— ì ìš©í•˜ê¸°ì— ì•ì„œ ì‹¤ ì„œë²„ì—ì„œ FQDN outboundì˜ <u>ì‚¬ìš© ë¦¬ìŠ¤íŠ¸</u>ë¥¼ ì •ë¦¬í•˜ëŠ”ë° ìœ ìš©í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>

<p>Security &gt; Egress Control &gt; (Optional) Egress FQDN Discovery &gt; Gateway â€œStartâ€ (ì„ íƒëœ GatewayëŠ” FQDN Filterì— ì—°ê²°ì´ ì•ˆ ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.)</p>

<p><img src="/img/posts_aviatrix/fqdn-discovery-start.png" alt="23" /></p>

<p>í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ Private-Subnetì—ì„œ ìš´ì˜ë˜ê³  ìˆëŠ” ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> <span class="nt">-k</span> <span class="nt">-s</span> <span class="nt">-o</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}</span><span class="se">\n</span><span class="s2">"</span> https://tech.socarcorp.kr
</code></pre></div></div>

<p>1ë²ˆ HA í…ŒìŠ¤íŠ¸ë¡œ ì¸í•´ ë³€ê²½ëœ Aviatrix-GW-hagwì—ì„œ ë°œìƒí•œ FQDN ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p><img src="/img/posts_aviatrix/fqdn-discovery-status.png" alt="23" /></p>

<p>í…ŒìŠ¤íŠ¸ ê²°ê³¼: FQDN Discovery ê¸°ëŠ¥ì„ í†µí•´ <strong>ì‹¤ ì„œë²„</strong> FQDN Outboundë¥¼ ëª¨ë‘ ì‚¬ì „ì— í™•ì¸í•˜ê³ , í•„ìš” ìœ ë¬´ì— ë”°ë¼ì„œ FQDN Filter ì •ì±…ì„ ì •ì˜í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.</p>

<h3 id="3-httpstls-í†µì‹ ì„-gatewayê°€-ê°€ë¡œì±„ì„œ-ì–´ë””ë¡œ-ê°€ëŠ”ì§€-í™•ì¸í• -ìˆ˜-ìˆëŠ”-ì´ìœ ">3. HTTPS/TLS í†µì‹ ì„ Gatewayê°€ ê°€ë¡œì±„ì„œ ì–´ë””ë¡œ ê°€ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆëŠ” ì´ìœ </h3>
<p>2ë²ˆ ë‚´ìš©ì„ ë³´ë©´ HTTPS/TLS í†µì‹ ì„ <strong>Gatewayê°€ ì–´ë–»ê²Œ?</strong> ê°€ë¡œ ì±„ì§€ ë¼ëŠ” ì˜ë¬¸ì ì´ ìˆìŠµë‹ˆë‹¤, í•´ë‹¹ ë‚´ìš©ì€ SNIì— ëŒ€í•œ ì´í•´ê°€ í•„ìš”í•´ì„œ SNI ë‚´ìš©ì„ ì •ë¦¬í•´ ë“œë¦½ë‹ˆë‹¤.</p>

<p><code class="highlighter-rouge">SNI(Server Name Indication)</code></p>
<ul>
  <li>ë‘ TCP í”¼ì–´ ê°„ ì•”í˜¸í™”ëœ TLS í„°ë„ì„ ì„¤ì •í•  ìˆ˜ ìˆê³ , í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ì— ëŒ€í•œ IP ì£¼ì†Œ ë§Œ ì•Œê³  ìˆì–´ë„ TLS Handshakeë¥¼ ìˆ˜í–‰ í•  ìˆ˜ ìˆì§€ë§Œ, <u>ì„œë²„ê°€ ê°ê° ê³ ìœ í•œ TLS ì¸ì¦ì„œë¥¼ ê°€ì§„ ì—¬ëŸ¬ ê°œì˜ ë…ë¦½ ì‚¬ì´íŠ¸ë¥¼ ë™ì¼í•œ IP ì£¼ì†Œë¡œ ìš´ì˜í•˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´</u> SNI í™•ì¥ì´ TLS í”„ë¡œí† ì½œì— ë„ì…ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
  <li>SNIëŠ” <code class="highlighter-rouge">ì—¬ëŸ¬ ê°œ</code>ì˜ ë…ë¦½ ì‚¬ì´íŠ¸ ì¤‘ì— <code class="highlighter-rouge">í•˜ë‚˜ì˜ ì‚¬ì´íŠ¸</code>ë¥¼ ì§€ì • í•˜ê¸° ìœ„í•´ í•„ìš”í•œ í•„ë“œì…ë‹ˆë‹¤.</li>
  <li>í•˜ì§€ë§Œ, TLS Handshakeì—ì„œ ì•”í˜¸í™” í†µì‹ ì„ <code class="highlighter-rouge">í•˜ê¸° ì „ì¸</code> <strong>ClientHello</strong> ê³¼ì •ì— ì ìš©ë©ë‹ˆë‹¤.</li>
</ul>

<p><code class="highlighter-rouge">TLS Handshake</code></p>

<div class="mermaid">
sequenceDiagram
opt ì•”í˜¸í™” X
    Client -&gt;&gt; Server: ClientHello
    Server -&gt;&gt; Client: ServerHello
    end
opt ì•”í˜¸í™”
    Server -&gt;&gt; Client: ServerCertificate
    Server -&gt;&gt; Client: ServerHelloDone
    Client -&gt;&gt; Server: KeyExhange/ChangeCipherSpec/Finished
    Server -&gt;&gt; Client: ChangeCipherSpec/Finished
    end
    Server -&gt; Client: Application Date
</div>

<p><code class="highlighter-rouge">TLS_1.3 Handshake &gt; ClientHello</code></p>

<div class="mermaid">
sequenceDiagram
    Client -&gt;&gt; Gateway: TLS ClientHello, SNI=www.socar.kr, Client`s Diffie-Hellman Key
opt FQDN Filter
    Client --&gt; Gateway: SNI Check
Note right of Client: FQDN Filter ì„±ê³µ
    Gateway -&gt;&gt; Server: TLS ClientHello, SNI=www.socar.kr, Client`s Diffie-Hellman Key
end
opt FQDN Filter
    Client --&gt; Gateway: SNI Check
Note right of Client: FQDN Filter ì‹¤íŒ¨
    Gateway --&gt;&gt; Client: TLS ClientHello, SNI=www.socar.kr, Client`s Diffie-Hellman Key
end
</div>

<ul>
  <li>Gatewayê°€ SNI í•„ë“œë¥¼ í™•ì¸í•˜ëŠ” ë°©ë²•ì€ <code class="highlighter-rouge">ì•”í˜¸í™”ê°€ ë˜ì§€ ì•Šì€ í‰ë¬¸</code>ìœ¼ë¡œ ì „ì†¡í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.</li>
  <li>ì‚¬ìš©ì ì…ì¥ì—ì„œëŠ” SNIëŠ” ì ‘ì†í•˜ë ¤ëŠ” ì‚¬ì´íŠ¸ ì£¼ì†Œê°€ ì•”í˜¸í™”ë˜ì§€ ì•Šì€ í‰ë¬¸ìœ¼ë¡œ ì „ì†¡ë˜ê¸° ë•Œë¬¸ì—, <code class="highlighter-rouge">íƒ€ì¸</code>ì´ ì¤‘ê°„ì— íŠ¸ë˜í”½ì„ ê°€ë¡œì±„ì„œ <u>ì‚¬ìš©ìê°€ ì¡°íšŒí•˜ëŠ” ì‚¬ì´íŠ¸</u>ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
  <li>TLS 1.3 ìµœì¢…ì•ˆì´ ì¡°ìœ¨ë˜ëŠ” ì‹œê¸°ì—ëŠ” <code class="highlighter-rouge">Encrypted SNI</code>ë¡œ ì¸í•´ì„œ Gatewayê°€ SNI í•„ë“œë¥¼ í™•ì¸í•˜ëŠ” ë°©ë²•ì´ ë¶ˆê°€ëŠ¥ í•  ìˆ˜ë„ ìˆì—ˆì§€ë§Œ, <code class="highlighter-rouge">TLS 1.3 ìµœì¢…ì•ˆ</code> ì—ì„œëŠ” <code class="highlighter-rouge">í•„ìˆ˜</code>ê°€ ì•„ë‹Œ, <code class="highlighter-rouge">í™•ì¥</code> ê¸°ëŠ¥ìœ¼ë¡œì¨ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.
    <ul>
      <li><a href="https://ko.wikipedia.org/wiki/%EC%84%9C%EB%B2%84_%EB%84%A4%EC%9E%84_%EC%9D%B8%EB%94%94%EC%BC%80%EC%9D%B4%EC%85%98">Encrypted SNI</a></li>
    </ul>
  </li>
</ul>

<h3 id="4-aviatrix-cloudformation-templateì˜-role-policy-ì´í•´í•˜ê¸°">4. Aviatrix-CloudFormation Templateì˜ role, policy ì´í•´í•˜ê¸°</h3>

<ul>
  <li>CloudFormation Templateì€ ì–´ë–¤ ë‚´ìš©ì„ ê°€ì§€ê³  ìˆì„ê¹Œ?</li>
  <li>ì™œ Gateway ì„œë²„ê°€ ìë™ìœ¼ë¡œ ì„¤ì¹˜ ë˜ì—ˆì„ê¹Œ?</li>
  <li>ì™œ Private-Subnet Route Table ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ê°€ ë˜ì—ˆì„ê¹Œ?</li>
  <li>ë©€í‹° Account êµ¬ì„±ì€ ì–´ë–»ê²Œ ê°€ëŠ¥í• ê¹Œ?</li>
</ul>

<p>ìœ„ì— ë‚´ìš©ì€ CloudFormation Templateì˜ <u>Role, Policy</u> ê´€ê³„ë¥¼ ë³´ë©´ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì•„ë˜ì˜ ì†ŒìŠ¤ëŠ” CloudFormation Templateì˜ ì¼ë¶€ ë‚´ìš©ì…ë‹ˆë‹¤.</p>

<p>EC2 ìƒì„± ê³¼ì •ì—ì„œ aviatrix-role-ec2ë¥¼ ë“±ë¡í•˜ëŠ” ë‚´ìš©ì…ë‹ˆë‹¤.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="nl">"IAMRoleParam"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Determine if IAM roles aviatrix-role-ec2 and aviatrix-role-app should be created."</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Default"</span><span class="p">:</span><span class="w"> </span><span class="s2">"New"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"AllowedValues"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"aviatrix-role-ec2"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"New"</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>
<p>EC2ì— ë“±ë¡í•˜ê¸° ìœ„í•œ role-ec2ë¥¼ ìƒì„±í•˜ëŠ” ë‚´ìš©ì…ë‹ˆë‹¤.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="nl">"AviatrixRoleEC2"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::IAM::Role"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AviatrixIAMRoleNotExist"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"RoleName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aviatrix-role-ec2"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"AssumeRolePolicyDocument"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                        </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nl">"Service"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                                </span><span class="s2">"ec2.amazonaws.com"</span><span class="w">
                            </span><span class="p">]</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                            </span><span class="s2">"sts:AssumeRole"</span><span class="w">
                        </span><span class="p">]</span><span class="w">
                    </span><span class="p">}]</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>
<p>ì—¬ê¸°ì„œ <code class="highlighter-rouge">ì£¼ëª©í•  ì </code>ì´ ìˆìŠµë‹ˆë‹¤, role-appì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” <a href="https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/reference_policies_elements_principal.html">Principal</a>ì— â€œRefâ€: â€œAWS::AccountIdâ€ ë“±ë¡ì„ í†µí•´ì„œ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="nl">"AviatrixRoleApp"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::IAM::Role"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AviatrixIAMRoleNotExist"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"RoleName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aviatrix-role-app"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"AssumeRolePolicyDocument"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                        </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nl">"AWS"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                                </span><span class="nl">"Fn::Join"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                                    </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">
                                        </span><span class="s2">"arn:aws:iam::"</span><span class="p">,</span><span class="w">
                                        </span><span class="p">{</span><span class="w">
                                            </span><span class="nl">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::AccountId"</span><span class="w">
                                        </span><span class="p">},</span><span class="w">
                                        </span><span class="s2">":root"</span><span class="w">
                                    </span><span class="p">]</span><span class="w">
                                </span><span class="p">]</span><span class="w">
                            </span><span class="p">}]</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                            </span><span class="s2">"sts:AssumeRole"</span><span class="w">
                        </span><span class="p">]</span><span class="w">
                    </span><span class="p">}]</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>
<p>ì—¬ê¸°ì„œ <code class="highlighter-rouge">ì£¼ëª©í•  ì </code>ì€ <u>arn:aws:iam::*:role/aviatrix-*</u> ì„¤ì •ì— ìˆìŠµë‹ˆë‹¤. í•´ë‹¹ <code class="highlighter-rouge">"*"</code>ì„¤ì •ìœ¼ë¡œ role-ec2ì˜ PolicyëŠ” arn:aws:iam::<code class="highlighter-rouge">AccountId</code>:role/aviatrix-role-appì˜ Policyë¥¼ í• ë‹¹ ë°›ì•„ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œë©ë‹ˆë‹¤.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="nl">"CreateAviatrixAssumeRolePolicy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::IAM::ManagedPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AviatrixIAMRoleNotExist"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"ManagedPolicyName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aviatrix-assume-role-policy"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Policy for creating aviatrix-assume-role-policy"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"PolicyDocument"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
                            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                                </span><span class="s2">"sts:AssumeRole"</span><span class="w">
                            </span><span class="p">],</span><span class="w">
                            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::*:role/aviatrix-*"</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="p">{</span><span class="w">
                            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
                            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                                </span><span class="s2">"aws-marketplace:MeterUsage"</span><span class="w">
                            </span><span class="p">],</span><span class="w">
                            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">]</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"Roles"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                    </span><span class="nl">"Ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AviatrixRoleEC2"</span><span class="w">
                </span><span class="p">}]</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>
<p>role-app Policyì˜ ê²½ìš°ì—ëŠ” ì•„ë˜ ì¶”ê°€ëœ ì´ë¯¸ì§€ì²˜ëŸ¼ <u>ë§ì€ Action</u>ì´ ì •ì˜ë˜ì–´ìˆìŠµë‹ˆë‹¤.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="nl">"CreateAviatrixAppPolicy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::IAM::ManagedPolicy"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AviatrixIAMRoleNotExist"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"ManagedPolicyName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"aviatrix-app-policy"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"Description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Policy for creating aviatrix-app-policy"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"Path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"PolicyDocument"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
                            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">..........................</span><span class="w">
</span></code></pre></div></div>
<p><img src="/img/posts_aviatrix/role-check.png" alt="4" /></p>

<p>CloudFormation Template ìœ¼ë¡œ êµ¬ì„±ëœ <code class="highlighter-rouge">AWS ì¸í”„ë¼ì˜ ì´ë¯¸ì§€</code>ë¥¼ í†µí•´ ì •ë¦¬í•  ê²½ìš°, ì•„ë˜ì™€ ê°™ì€ êµ¬ì„±ì´ ì„¤ì •ë©ë‹ˆë‹¤.</p>

<ul>
  <li>Aviatrix Controller Instance ì— role-ec2 ì„¤ì •</li>
</ul>

<p><img src="/img/posts_aviatrix/role-ec2.png" alt="5" /></p>
<ul>
  <li>role-ec2 ì— ëŒ€í•œ Policy ëŠ” ì•„ë˜ì™€ ê°™ì´ ì„¤ì •ë˜ë©°, í•´ë‹¹ ì„¤ì •ì—ì„œ <u>STS ì„¤ì •</u>ì„ ì£¼ì˜ ê¹Šê²Œ ì´í•´í•©ë‹ˆë‹¤.</li>
</ul>

<p><img src="/img/posts_aviatrix/role-ec2-policy.png" alt="6" /></p>

<ul>
  <li>ìœ„ì˜ ì´ë¯¸ì§€ë¥¼ JSON í˜•íƒœë¡œ í™•ì¸í•˜ë©´ ì´í•´ê°€ ë” ì‰½ìŠµë‹ˆë‹¤.</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"sts:AssumeRole"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:iam::*:role/aviatrix-*"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="w">
        </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>Aviatrix Controller ì›¹ í˜ì´ì§€ì˜ Onboarding ì¹´í…Œê³ ë¦¬ì—ì„œ Cloud Platformì— ë§ê²Œ ì„¤ì •ì„ í•˜ê²Œ ë˜ë©´, AWSì˜ ê²½ìš° role-ec2ê°€ role-appì˜ policyì„ <code class="highlighter-rouge">ìœ„ì„</code> ë°›ì•„ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìƒíƒœê°€ ë©ë‹ˆë‹¤. role-ec2ëŠ” Aviatrix Controller Instanceì— ë“±ë¡ ë˜ì–´ìˆëŠ” role ì´ê¸° ë•Œë¬¸ì—, Aviatrix Controller ì›¹ í˜ì´ì§€ì—ì„œ role-appì— ì ìš© ë˜ì–´ìˆëŠ” Policy ì— ëŒ€í•œ ì´ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. <code class="highlighter-rouge">(ë©€í‹° Accountì˜ ê²½ìš°ì—ëŠ” ë©€í‹° Accountì— ì„¤ì • ë˜ì–´ ìˆëŠ” role-appì— ëŒ€í•œ AccountId Trust ë“±ë¡ì„ ì§„í–‰í•˜ì—¬, ë©€í‹° Accountì˜ role-appì„ Controller Accountì˜ role-appì´ ê³µìœ  ë°›ì•„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ë™ì¼í•©ë‹ˆë‹¤.)</code></li>
</ul>

<p><img src="/img/posts_aviatrix/role-app-trust.png" alt="7" /></p>

<hr />

<h2 id="multiple-aws-accounts-with-role-switchin-aviatrix-architecture">Multiple AWS Accounts with Role Switchin Aviatrix Architecture</h2>

<p><img src="/img/posts_aviatrix/role-ec2-app-muac.png" alt="8" /></p>

<hr />

<h2 id="ì •ë¦¬">ì •ë¦¬</h2>
<ul>
  <li>ìì„¸í•œ ì„¤ëª…ì„ í•˜ê¸° ìœ„í•´ ë§ì€ ì´ë¯¸ì§€ê°€ ì¶”ê°€ ë˜ì—ˆì§€ë§Œ, ì‹¤ì§ˆì ìœ¼ë¡œëŠ” AWS ë§ˆì¼“í”Œë ˆì´ìŠ¤ì—ì„œ ë¼ì´ì„ ìŠ¤ êµ¬ì… ì´í›„ì— ì§„í–‰ë˜ëŠ” ì ˆì°¨ê°€ ê°„ë‹¨í•˜ë©° ì‚¬ìš©ìê°€ ì§ì ‘ <u>ìˆ˜ë™</u>ìœ¼ë¡œ ì‘ì—…í•´ì•¼í•˜ëŠ” ë‚´ìš©ì´ <code class="highlighter-rouge">ê±°ì˜ì—†ìŠµë‹ˆë‹¤.</code></li>
  <li>Aviatrixì˜ ê²½ìš°ì—ëŠ” ê¸°ì¡´ì˜ Cisco ë° paloalto ì™€ëŠ” ë‹¤ë¥¸ Cloud í™˜ê²½ì— ë§ê²Œ ê°œë°œì´ ë˜ì—ˆë‹¤ëŠ” ê²ƒì„ ì‰½ê²Œ ëŠë‚„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. <code class="highlighter-rouge">Roleì˜ í™œìš©</code> ë° ìœ„ì—ì„œëŠ” ìì„¸í•˜ê²Œ ë‹¤ë£¨ì§€ ì•Šì•˜ì§€ë§Œ, <u>"EXPORT TO TERRAFORM"</u> ì¹´í…Œê³ ë¦¬ ë¶€ë¶„ì—ì„œ ë¦¬ì†ŒìŠ¤ í˜•ì‹ì— ë§ëŠ” *.tf íŒŒì¼ë“¤ì„ ë‹¤ìš´ë¡œë“œ ë°›ì•„ì„œ IaC í™˜ê²½ì— í™œìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>í…ŒìŠ¤íŠ¸ ê³¼ì •ì—ì„œëŠ” ë‹¨ì¼ Accountë¥¼ í™œìš©í•˜ì˜€ì§€ë§Œ, ì˜ì¹´ì—ì„œëŠ” <code class="highlighter-rouge">Transit GWë¥¼ ì´ìš©í•œ íŠ¸ë˜í”½ ì¤‘ì•™ ê´€ë¦¬</code>ë¥¼ í†µí•´ì„œ ìš´ì˜í•˜ê³  ìˆê¸° ë•Œë¬¸ì— On-premise ì ìš© ë“± ë‹¤ì–‘í•œ ì•„í‚¤í…ì²˜ êµ¬ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
  <li>ë§¤ë‹ˆì € Cloud Platformì—ì„œ ëª¨ë‘ ìš´ì˜ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ì´í›„ í™•ì¥ì„± ë° íŠ¹ì • Cloud Platformì— <a href="https://en.wikipedia.org/wiki/Vendor_lock-in">Lock-in</a> ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì¥ì ì´ ìˆìŠµë‹ˆë‹¤.</li>
  <li>ê·¸ ë°–ì— ì‚¬ìš©í•œ ë§Œí¼ë§Œ ì§€ê¸‰í•˜ëŠ” Cloud ë°©ì‹ì— ë§ëŠ” <u>ë¼ì´ì„ ìŠ¤ ì •ì±…</u>ë„ ë¹„ìš©ì ì¸ ë¶€ë¶„ì—ì„œëŠ” ë§ì€ ì¥ì ì´ ìˆë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤.</li>
  <li><code class="highlighter-rouge">ë§ì€ ì¥ì </code> ê°€ìš´ë° ì§€ì†ê°€ëŠ¥ì„±ì— ëŒ€í•œ ë¬¸ì œëŠ” ìˆìŠµë‹ˆë‹¤, TLS 1.3 ìµœì¢…ì•ˆì´ ì ìš©ëœ ì§€ ì–¼ë§ˆ ë˜ì§€ ì•Šì€ ìƒí™©ì´ì§€ë§Œ, Gatewayê°€ SNI í•„ë“œë¥¼ í†µí•´ FQDN Filter ê³¼ì •ì´ ì´í›„ <strong>SNI ì•”í˜¸í™” ì´í›„ FQDN Filterë¥¼ ì–´ë–»ê²Œ ì§„í–‰í•  ê²ƒì¸ê°€</strong>ì— ëŒ€í•œ ë¬¸ì œì ì´ ìˆìŠµë‹ˆë‹¤.</li>
</ul>

<hr />

<h2 id="ê³„íšì¤‘ì¸-aviatrixì„-ì´ìš©í•œ-ë‹¤ì–‘í•œ-í™˜ê²½-êµ¬ì¶•">ê³„íšì¤‘ì¸ Aviatrixì„ ì´ìš©í•œ ë‹¤ì–‘í•œ í™˜ê²½ êµ¬ì¶•</h2>
<ul>
  <li>Aviatrix ë¡œê·¸, ë¶„ì„ (+ì‹œê°í™”/ìë™í™”)</li>
  <li>DMZ êµ¬ì¶• (+VDI)</li>
  <li>Remote Workì˜ ë‹¤ì–‘í•œ ì„¤ê³„ (+VPN, +VDI)</li>
  <li>Inbound íŠ¸ë˜í”½ì— ëŒ€í•œ ì„¸ë¶€ì ì¸ ë¡œê·¸ ë° ë¶„ì„ (+ì‹œê°í™”)</li>
  <li>VM to VM ê°„ì˜ íŠ¸ë˜í”½ ê´€ë¦¬</li>
</ul>

        </div>
        
        <hr>
        <div class="clearfix">
          
          <a class="btn btn-primary float-left" href="/security/2019/07/31/keycloak-sso.html" data-toggle="tooltip" data-placement="top" title="Keycloakë¥¼ ì´ìš©í•œ SSO êµ¬ì¶•(web + wifi + ssh)">&larr; Previous<span class="d-none d-md-inline">
              Post</span></a>
          
          
          <a class="btn btn-primary float-right" href="/data/2020/01/12/oreilly-strata-newyork-2019-review.html" data-toggle="tooltip" data-placement="top" title="O'reilly Strata Data Conference New York 2019 í›„ê¸°">Next<span class="d-none d-md-inline">
              Post</span> &rarr;</a>
          
        </div>
        <div>
          <p class="recuit">ì˜ì¹´ëŠ” ì–¸ì œë‚˜ ì˜ì¹´ ì„œë¹„ìŠ¤ë¥¼ í•¨ê»˜ ë§Œë“¤ë©° ê¸°ìˆ ì ì¸ ë¬¸ì œë¥¼ í•¨ê»˜ í’€ì–´ë‚˜ê°ˆ ëŠ¥ë ¥ìˆëŠ” ê°œë°œì/ë””ìì´ë„ˆ/ê¸°íšì/ë°ì´í„° ì‚¬ì´ì–¸í‹°ìŠ¤íŠ¸ ë“±ì„ ëª¨ì‹œê³  ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ <a href="https://bit.ly/SOCAR-RECRUIT">ì˜ì¹´ ì±„ìš©ê³µê³  í˜ì´ì§€</a>ë¥¼ í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤ :)</p>
        </div>
      </div>
    </div>
    <!-- utterance comments -->
    <script src="https://utteranc.es/client.js"
        repo="socar-inc/techblog-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
    </script>
  </div>

<script>
  // ref https://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '#toc',
    contentSelector: '.post-content',
    headingSelector: 'h1, h2, h3',
    hasInnerContainers: true,
    collapseDepth: 6,
    linkClass: 'toc-link'
  });


  $(window).on('scroll', function() {
      let scrollTop = $(window).scrollTop()
      let scrollBottom =  scrollTop + $(window).height()
      let contentOffsetTop = $(".post-content").offset().top
      let contentOffsetBottom = contentOffsetTop + $(".post-content").height()
      let elementHeight = $(".post-content").height(); 

      if ((scrollTop < contentOffsetTop) || (scrollBottom >= contentOffsetBottom)) {
        // $('.toc').css('visibility', 'hidden')
        $('.toc').addClass("toc-hidden")
      }
      else if (scrollTop >= contentOffsetTop) {
        $(".toc").removeClass("toc-hidden")
      }
  });
</script>


  <!-- Footer -->

<hr>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-9 mx-auto">
        <ul class="list-inline text-center">
          
          
          
          <li class="list-inline-item">
            <a href="https://www.facebook.com/socarsharing">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; SOCAR 2023 | tech_branding@socar.kr</p>
      </div>
    </div>
  </div>
</footer>


  <script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script>
<script src="/assets/scripts.js"></script>
<script src="/assets/mermaid-8.2.3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-30551922-27"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-30551922-27');
</script>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MZ79TFM');</script>
<!-- End Google Tag Manager -->


</body>

</html>
